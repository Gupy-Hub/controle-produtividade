<script src="js/config.js"></script>
<script src="js/sistema.js"></script> <script src="js/layout.js"></script>

<script>
    const sessao = JSON.parse(localStorage.getItem('usuario'));
    const isMgr = sessao ? sessao.funcao === 'Gestora' : false;
    let myChart = null;
    // Mapas agora vêm de Sistema.Dados.mapaUsuarios

    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Configura Data com o Cérebro
        Sistema.Datas.configurarInput('filtro-data-manual', 'dash_date_ref', atualizarDashboard);
        
        // 2. Carrega Usuários
        await Sistema.Dados.carregarUsuarios();
        
        // 3. Configura UI Gestora
        if (isMgr) {
            document.getElementById('container-filtro-user').classList.remove('hidden');
            carregarOpcoesGestor();
        }

        atualizarDashboard();
    });

    function carregarOpcoesGestor() {
        const sel = document.getElementById('filtro-user');
        // Limpa exceto os primeiros
        while (sel.options.length > 3) sel.remove(3);
        
        // Usa o mapa global do Sistema
        const users = Object.entries(Sistema.Dados.mapaUsuarios)
            .filter(([id, u]) => u.funcao === 'Assistente')
            .sort((a, b) => a[1].nome.localeCompare(b[1].nome));

        users.forEach(([id, u]) => {
            const opt = document.createElement('option');
            opt.value = id; // Aqui usamos ID para selecionar no dropdown
            opt.text = u.nome;
            sel.appendChild(opt);
        });
    }

    async function atualizarDashboard() {
        const dataStr = document.getElementById('filtro-data-manual').value;
        const dateObj = Sistema.Datas.obterDataObjeto(dataStr);
        
        // ... (Lógica de datas igual, usando dateObj) ...
        const ano = dateObj.getFullYear();
        const mes = dateObj.getMonth();
        const dataInicio = new Date(ano, mes, 1).toISOString().split('T')[0];
        const dataFim = new Date(ano, mes + 1, 0).toISOString().split('T')[0];

        // Definição de Target
        let targetName = Sistema.Dados.mapaUsuarios[sessao.id]?.nome;
        let viewingTime = false;
        
        if (isMgr) {
            const val = document.getElementById('filtro-user').value;
            if (val === 'time') viewingTime = true;
            else if (val !== 'me') targetName = Sistema.Dados.mapaUsuarios[val]?.nome;
        }

        // Busca
        const { data: rawData } = await _supabase.from('producao')
            .select('*')
            .gte('data_referencia', dataInicio)
            .lte('data_referencia', dataFim);

        // USANDO O CÉREBRO PARA NORMALIZAR
        // Mas atenção: o dashboard precisa de dados diários para o gráfico, 
        // e o normalizarProducao do Sistema retorna o RESUMO acumulado.
        // Para o Dashboard, precisamos da lógica temporal.
        // Vamos manter a lógica de gráfico aqui, MAS usando o mapaUsuarios do Sistema.js
        
        // ... (Restante do código de gráficos mantido, mas usando Sistema.Dados.mapaUsuarios) ...
        // Vou resumir a função principal de processamento do gráfico para usar o Sistema:
        
        processarDadosGrafico(rawData || [], viewingTime, targetName);
    }

    function processarDadosGrafico(rawData, viewingTime, targetName) {
        // Agrupa por Dia -> Nome (Normalização Temporal)
        const porDia = {};
        
        rawData.forEach(item => {
            const u = Sistema.Dados.mapaUsuarios[item.usuario_id];
            if (!u || u.funcao !== 'Assistente') return; // Regra global
            
            const dia = item.data_referencia;
            const nome = u.nome;
            
            if(!porDia[dia]) porDia[dia] = {};
            if(!porDia[dia][nome]) porDia[dia][nome] = { qtd: 0, meta: item.meta_diaria || 650 };
            
            porDia[dia][nome].qtd += item.quantidade;
        });

        // Agora gera os arrays para o ChartJS
        // ... (Lógica de arrays igual à anterior, iterando porDia) ...
        // ... Atualiza KPIs, Tabela e Gráfico com estes dados ...
        
        // Nota: Por brevidade, mantive a estrutura lógica, 
        // mas a chave é que agora 'u' vem de Sistema.Dados.mapaUsuarios
        // garantindo que se o ID mudar mas o nome for igual, o sistema reconhece.
        
        atualizarInterfaceComDadosProcessados(porDia, viewingTime, targetName);
    }
    
    // ... (Funções de renderização visual chart/tabela mantidas do passo anterior) ...
    // Basta colar a função renderizarGraficos/Tabela do passo anterior aqui, 
    // certificando-se de que elas recebem os dados já processados.
</script>