<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Minha Área</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style> body { font-family: 'Nunito', sans-serif; background-color: #f8fafc; } .btn-tab.active { @apply bg-white text-blue-600 shadow-sm border-slate-100; } </style>
</head>
<body class="bg-slate-50">
    <script src="js/config.js"></script>
    <script src="js/sistema.js"></script>
    <script src="js/layout.js"></script>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl font-black text-slate-800">Minha Área</h1>
            <div class="flex items-center gap-3">
                <div id="container-filtro-user" class="hidden">
                    <select id="filtro-user" onchange="atualizarDashboard()" class="bg-white border border-slate-200 rounded-lg p-2 font-bold text-slate-600 outline-none">
                        <option value="me">Minha Visão</option>
                        <option value="time">Time Todo</option>
                    </select>
                </div>
                <div class="relative">
                    <span class="absolute -top-2 left-2 bg-white px-1 text-[10px] font-bold text-blue-500">DATA REF</span>
                    <input type="text" id="data-global" class="w-32 py-2 text-center border-2 border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500" placeholder="DD/MM/AAAA">
                </div>
            </div>
        </div>

        <div id="aviso-gestora-view" class="hidden bg-blue-50 p-8 rounded-xl text-center text-blue-800 font-bold mb-8">
            Modo Gestão: Selecione "Time Todo" ou uma Assistente para ver dados.
        </div>

        <div id="conteudo-principal">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">Produção (Mês)</span>
                    <h2 class="text-4xl font-black text-blue-600 mt-2" id="kpi-total">--</h2>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">Atingimento</span>
                    <h2 class="text-4xl font-black text-emerald-600 mt-2" id="kpi-ating">--%</h2>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">Média Diária</span>
                    <h2 class="text-4xl font-black text-purple-600 mt-2" id="kpi-media">--</h2>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 min-h-[400px]">
                <h3 class="font-bold text-slate-700 mb-4">Evolução Mensal</h3>
                <canvas id="chartPrincipal"></canvas>
            </div>
        </div>
    </div>

    <script>
        const sessao = JSON.parse(localStorage.getItem('usuario'));
        const isMgr = sessao ? sessao.funcao === 'Gestora' : false;
        let myChart = null;

        document.addEventListener('DOMContentLoaded', async () => {
            Sistema.Datas.configurarInputGlobal('data-global', atualizarDashboard);
            await Sistema.Dados.carregarUsuarios();

            if (isMgr) {
                document.getElementById('container-filtro-user').classList.remove('hidden');
                const sel = document.getElementById('filtro-user');
                Object.entries(Sistema.Dados.mapaUsuarios).forEach(([id, u]) => {
                    if (u.funcao === 'Assistente') {
                        const opt = document.createElement('option');
                        opt.value = id; opt.text = u.nome;
                        sel.appendChild(opt);
                    }
                });
            }
            atualizarDashboard();
        });

        async function atualizarDashboard() {
            const ref = Sistema.Datas.obterDataObjeto();
            const ano = ref.getFullYear();
            const mes = ref.getMonth();
            const inicio = new Date(ano, mes, 1).toISOString().split('T')[0];
            const fim = new Date(ano, mes + 1, 0).toISOString().split('T')[0];

            let targetName = Sistema.Dados.mapaUsuarios[sessao.id]?.nome;
            let viewingTime = false;

            if (isMgr) {
                const val = document.getElementById('filtro-user').value;
                if (val === 'me') {
                    document.getElementById('conteudo-principal').classList.add('hidden');
                    document.getElementById('aviso-gestora-view').classList.remove('hidden');
                    return;
                }
                document.getElementById('conteudo-principal').classList.remove('hidden');
                document.getElementById('aviso-gestora-view').classList.add('hidden');
                
                if (val === 'time') viewingTime = true;
                else targetName = Sistema.Dados.mapaUsuarios[val]?.nome;
            }

            const { data } = await _supabase.from('producao').select('*').gte('data_referencia', inicio).lte('data_referencia', fim);
            const lista = Sistema.Dados.normalizar(data || []);

            let dadosAlvo = { total: 0, meta: 0, dias: 0 };

            if (viewingTime) {
                // Soma do Time todo
                dadosAlvo.total = lista.reduce((a,b)=>a+b.total,0);
                dadosAlvo.meta = lista.reduce((a,b)=>a+b.meta,0);
                const diasTotal = lista.reduce((a,b)=>a+b.dias,0); // Soma de dias trabalhados
                dadosAlvo.dias = diasTotal;
            } else {
                const u = lista.find(p => p.nome === targetName);
                if (u) dadosAlvo = u;
            }

            const media = dadosAlvo.dias ? Math.round(dadosAlvo.total / dadosAlvo.dias) : 0;
            const ating = dadosAlvo.meta ? Math.round((dadosAlvo.total/dadosAlvo.meta)*100) : 0;

            document.getElementById('kpi-total').innerText = dadosAlvo.total.toLocaleString();
            document.getElementById('kpi-media').innerText = media.toLocaleString();
            document.getElementById('kpi-ating').innerText = ating + '%';

            // Chart Simples
            const ctx = document.getElementById('chartPrincipal').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: viewingTime ? lista.map(u=>u.nome) : ['Total', 'Meta'], // Simplificação para garantir visualização
                    datasets: [{
                        label: 'Produção',
                        data: viewingTime ? lista.map(u=>u.total) : [dadosAlvo.total, dadosAlvo.meta],
                        borderColor: '#3b82f6', tension: 0.3
                    }]
                }
            });
        }
    </script>
</body>
</html>