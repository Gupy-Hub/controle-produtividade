<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidado Geral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
        .row-total td { background-color: #eff6ff !important; font-weight: 800; color: #1e40af; border-top: 2px solid #bfdbfe; }
        .row-sub td { background-color: #f8fafc; font-weight: 700; color: #64748b; font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase; padding-top: 20px; }
        .col-fixed { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #e2e8f0; }
        .row-total .col-fixed { background-color: #eff6ff; }
        .row-sub .col-fixed { background-color: #f8fafc; }
    </style>
</head>
<body class="text-slate-800">
    <script>
        const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
        const _supabase = window.supabase ? window.supabase.createClient(SB_URL, SB_KEY) : null;
        function renderNavbar() {
            const usuario = JSON.parse(localStorage.getItem('usuario')); if (!usuario) { window.location.href = 'index.html'; return; }
            const navbarHTML = `<nav class="bg-slate-900 text-white fixed top-0 left-0 w-full z-50 shadow-lg h-16 flex items-center justify-between px-6"><div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='produtividade.html'"><div class="flex flex-col leading-tight"><span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Controle de</span><span class="text-xl font-extrabold tracking-tighter text-white">PRODUTIVIDADE</span></div></div><div class="hidden md:flex items-center gap-1 h-full">${createNavLink('Gestão', 'gestao.html')}${createNavLink('Produtividade', 'produtividade.html')}${createNavLink('Performance', 'performance.html')}${createNavLink('Consolidado', 'consolidado.html')}${createNavLink('Minha Área', 'minha_area.html')}${createNavLink('Ferramentas', 'ferramentas.html')}</div><div class="flex items-center gap-4"><div class="text-right hidden sm:block"><span class="block text-sm font-bold text-white">${usuario.nome}</span><span class="block text-xs text-slate-400">${usuario.funcao}</span></div><button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-semibold border border-red-900/50 bg-red-900/10 px-3 py-1 rounded transition">Sair</button></div></nav><div class="h-20"></div>`;
            document.body.insertAdjacentHTML('afterbegin', navbarHTML);
        }
        function createNavLink(label, linkUrl) { const activeClass = window.location.href.includes(linkUrl) ? "bg-blue-700 text-white shadow-md" : "text-slate-300 hover:bg-slate-800 hover:text-white"; return `<a href="${linkUrl}" class="${activeClass} px-4 py-2 rounded-lg text-sm font-medium transition duration-200">${label}</a>`; }
        function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }
        renderNavbar();
    </script>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6"><h1 class="text-2xl font-bold text-slate-800">Visão Consolidada</h1><p class="text-slate-500 text-sm">Indicadores gerais agrupados por período.</p></div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6 flex flex-wrap gap-4 items-end">
            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Visão</label><select id="period-type" onchange="atualizarFiltros()" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg p-2.5 font-medium min-w-[140px]"><option value="mes">Mensal (Semanas)</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano_mes">Anual (Meses)</option><option value="dia">Diário</option></select></div>
            <div id="grp-ano"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ano</label><select id="year-selector" onchange="atualizarFiltros()" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg p-2.5 w-24 font-medium"></select></div>
            <div class="flex-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Período</label><select id="period-value" onchange="carregarConsolidado()" class="w-full bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg p-2.5 font-medium"></select><input type="date" id="date-picker" onchange="carregarConsolidado()" class="hidden w-full bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg p-2.5"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Produção Total</p><p class="text-3xl font-extrabold text-blue-700" id="p-total">0</p></div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média do Time</p><p class="text-3xl font-extrabold text-slate-800" id="p-media-time">0</p></div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden"><div class="absolute right-0 top-0 bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded-bl">Base Fixa</div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média (Base 17)</p><p class="text-3xl font-extrabold text-amber-600" id="p-media-ind">0</p></div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Ativos no Período</p><p class="text-3xl font-extrabold text-slate-800" id="p-headcount">0</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600 whitespace-nowrap"><thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200"><tr id="table-header"></tr></thead><tbody id="table-body" class="divide-y divide-slate-100"><tr><td class="p-8 text-center">Selecione um período...</td></tr></tbody></table></div></div>
    </div>
    <script>
        const HEAD_FIXED = 17;
        document.addEventListener('DOMContentLoaded', init);
        function init() { const y = document.getElementById('year-selector'); const cy = new Date().getFullYear(); y.innerHTML = ''; for(let i=cy; i>=2024; i--) y.innerHTML += `<option value="${i}">${i}</option>`; atualizarFiltros(); }
        function atualizarFiltros() {
            const t = document.getElementById('period-type').value; const v = document.getElementById('period-value'); const d = document.getElementById('date-picker'); const g = document.getElementById('grp-ano');
            v.innerHTML = ''; v.classList.remove('hidden'); d.classList.add('hidden'); g.classList.remove('hidden');
            if (t === 'dia') { v.classList.add('hidden'); d.classList.remove('hidden'); g.classList.add('hidden'); if(!d.value) d.value = new Date().toISOString().split('T')[0]; }
            else if (t === 'mes') { ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'].forEach((m,i) => { v.innerHTML += `<option value="${i+1}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`; }); }
            else if (t === 'trimestre') { v.innerHTML = '<option value="1">1º Trimestre</option><option value="2">2º Trimestre</option><option value="3">3º Trimestre</option><option value="4">4º Trimestre</option>'; }
            else if (t === 'semestre') { v.innerHTML = '<option value="1">1º Semestre</option><option value="2">2º Semestre</option>'; } else { v.innerHTML = '<option value="1">Ano Completo</option>'; }
            carregarConsolidado();
        }
        async function carregarConsolidado() {
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '<tr><td colspan="15" class="text-center py-8 text-slate-400">Calculando indicadores...</td></tr>';
            const t = document.getElementById('period-type').value; const y = document.getElementById('year-selector').value; const val = parseInt(document.getElementById('period-value').value); let s, e;
            if (t === 'dia') { s = e = document.getElementById('date-picker').value; }
            else if (t === 'mes') { s = `${y}-${String(val).padStart(2,'0')}-01`; e = `${y}-${String(val).padStart(2,'0')}-${new Date(y, val, 0).getDate()}`; }
            else if (t === 'trimestre') { const m = ((val-1)*3)+1; s = `${y}-${String(m).padStart(2,'0')}-01`; const mEnd = m+2; e = `${y}-${String(mEnd).padStart(2,'0')}-${new Date(y, mEnd, 0).getDate()}`; }
            else if (t === 'semestre') { s = val===1 ? `${y}-01-01` : `${y}-07-01`; e = val===1 ? `${y}-06-30` : `${y}-12-31`; } else { s = `${y}-01-01`; e = `${y}-12-31`; }
            try {
                const { data: rawData, error } = await _supabase.from('producao').select('*, usuarios(funcao, contrato)').gte('data_referencia', s).lte('data_referencia', e); if(error) throw error;
                let cols = []; if (t === 'dia') cols = ['Dia']; else if (t === 'mes') cols = ['S1','S2','S3','S4','S5']; else if (t === 'trimestre') cols = ['Mês 1','Mês 2','Mês 3']; else if (t === 'semestre') cols = ['M1','M2','M3','M4','M5','M6']; else cols = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                const numCols = cols.length; let st = {}; for(let i=1; i<=numCols; i++) st[i] = newStats(); st[99] = newStats();
                rawData.forEach(r => {
                    if(!r.usuarios || r.usuarios.funcao !== 'Assistente') return;
                    let b = 1; const dt = new Date(r.data_referencia + 'T12:00:00');
                    if(t === 'mes') { const firstDay = new Date(dt.getFullYear(), dt.getMonth(), 1).getDay(); b = Math.ceil((dt.getDate() + firstDay) / 7); }
                    else if (t === 'trimestre') b = (dt.getMonth() % 3) + 1; else if (t === 'semestre') b = (dt.getMonth() % 6) + 1; else if (t === 'ano_mes') b = dt.getMonth() + 1;
                    if(b > numCols) b = numCols;
                    // CORREÇÃO: Usar apenas SYSTEM
                    const sys = Number(r.quantidade) || 0;
                    [b, 99].forEach(k => {
                        if(!st[k]) return; const x = st[k];
                        x.users.add(r.usuario_id); x.dates.add(r.data_referencia); x.qty += sys; x.fifo += r.fifo; x.gt += r.gradual_total; x.gp += r.gradual_parcial; x.fc += r.perfil_fc;
                        if (r.usuarios.contrato && r.usuarios.contrato.includes('CLT')) { x.clt_users.add(r.usuario_id); x.clt_qty += sys; }
                        else { x.pj_users.add(r.usuario_id); x.pj_qty += sys; }
                    });
                });
                const hRow = document.getElementById('table-header'); hRow.innerHTML = `<th class="px-4 py-3 sticky left-0 bg-slate-50 z-20 border-r border-slate-200">Indicadores</th>` + cols.map(c => `<th class="px-4 py-3 text-center border-l border-slate-100">${c}</th>`).join('') + `<th class="px-4 py-3 text-center bg-blue-50 text-blue-800 border-l border-blue-100">TOTAL</th>`;
                let h = ''; const idxs = [...Array(numCols).keys()].map(i => i + 1); idxs.push(99);
                const mkRow = (label, getter, isCalc=false, isBold=false, isSub=false) => {
                    const rowClass = isBold ? 'row-total' : (isSub ? 'row-sub' : 'hover:bg-slate-50'); let tr = `<tr class="${rowClass} border-b border-slate-100"><td class="px-4 py-3 font-medium col-fixed">${label}</td>`;
                    idxs.forEach(i => {
                        const s = st[i]; const dias = s.dates.size || 1; const ativos = s.users.size || 1; const ativosCLT = s.clt_users.size || 1; const ativosPJ = s.pj_users.size || 1;
                        let val = 0; if (!isCalc) { val = getter(s); if (val instanceof Set) val = val.size; } else { val = getter(s, dias, ativos, ativosCLT, ativosPJ); }
                        const txt = val ? Math.round(val).toLocaleString() : (isBold ? '0' : '-'); const cellClass = i === 99 ? 'bg-blue-50 font-bold border-l border-blue-100 text-blue-900' : 'text-center border-l border-slate-50'; tr += `<td class="${cellClass} px-2 py-2">${txt}</td>`;
                    });
                    return tr + '</tr>';
                };
                h += mkRow('Ativos', s => s.users); h += mkRow('Dias Trabalhados', s => s.dates); h += mkRow('FIFO', s => s.fifo); h += mkRow('G. Parcial', s => s.gp); h += mkRow('G. Total', s => s.gt); h += mkRow('Perfil FC', s => s.fc); h += mkRow('Produção Total', s => s.qty, false, true);
                h += mkRow('Média Diária (Time)', (s, d) => s.qty / d, true); h += mkRow(`Média/Assistente (Base ${HEAD_FIXED})`, (s) => s.qty / HEAD_FIXED, true); h += mkRow(`Média Diária/Assist (Base ${HEAD_FIXED})`, (s, d) => s.qty / d / HEAD_FIXED, true);
                h += `<tr><td colspan="${numCols + 2}" class="px-4 py-6 bg-slate-50 font-bold text-slate-400 text-xs uppercase tracking-widest text-center border-y border-slate-200">Segmentação por Contrato</td></tr>`;
                h += mkRow('Produção CLT', s => s.clt_qty); h += mkRow('Média Diária/CLT', (s, d, a, ac) => s.clt_qty / d / ac, true);
                h += mkRow('Produção PJ', s => s.pj_qty); h += mkRow('Média Diária/PJ', (s, d, a, ac, ap) => s.pj_qty / d / ap, true);
                tbody.innerHTML = h;
                const tot = st[99]; const dTot = tot.dates.size || 1; document.getElementById('p-total').innerText = tot.qty.toLocaleString(); document.getElementById('p-media-time').innerText = Math.round(tot.qty / dTot).toLocaleString(); document.getElementById('p-media-ind').innerText = Math.round(tot.qty / dTot / HEAD_FIXED).toLocaleString(); document.getElementById('p-headcount').innerText = tot.users.size;
            } catch (err) { console.error(err); tbody.innerHTML = '<tr><td colspan="15" class="text-center py-4 text-red-500">Erro ao processar dados.</td></tr>'; }
        }
        function newStats() { return { users: new Set(), dates: new Set(), qty: 0, fifo: 0, gt: 0, gp: 0, fc: 0, clt_users: new Set(), clt_qty: 0, pj_users: new Set(), pj_qty: 0 }; }
    </script>
</body>
</html>