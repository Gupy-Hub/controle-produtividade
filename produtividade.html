<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Produtividade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style> 
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; } 
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #2563eb; border-color: #2563eb; background-color: #eff6ff; }
        .tab-btn:not(.active) { color: #64748b; }
        .tab-btn:not(.active):hover { color: #334155; background-color: #f8fafc; }
        .selected-row { background-color: #eff6ff !important; border-left: 4px solid #2563eb; }
        .row-ignored { opacity: 0.6; background-color: #f8fafc; filter: grayscale(0.8); }
        .col-tri { background-color: #f0f9ff; color: #0369a1; font-weight: bold; text-align: center; border-left: 1px solid #e0f2fe; }
        .col-sem { background-color: #e0f2fe; color: #075985; font-weight: 800; text-align: center; border-left: 2px solid #bae6fd; }
        .col-ano { background-color: #0f172a; color: #ffffff; font-weight: 800; text-align: center; border-left: 2px solid #cbd5e1; }
        .col-fixed { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #e2e8f0; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .status-select { 
            background: transparent; font-weight: bold; font-size: 0.75rem; 
            padding: 2px 6px; border-radius: 6px; cursor: pointer; outline: none;
            transition: all 0.2s;
        }
        .st-1 { color: #15803d; background-color: #dcfce7; border: 1px solid #86efac; } 
        .st-05 { color: #a16207; background-color: #fef9c3; border: 1px solid #fde047; } 
        .st-0 { color: #b91c1c; background-color: #fee2e2; border: 1px solid #fca5a5; } 
    </style>
</head>
<body class="text-slate-800">
    <script src="js/config.js"></script>
    <script src="js/sistema.js"></script> 
    <script src="js/layout.js"></script>

    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Painel de Gestão</h1>
                <p class="text-slate-500 text-sm font-medium">Validação e Indicadores.</p>
            </div>
            
            <div class="bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm flex overflow-x-auto max-w-full">
                <button onclick="mudarAba('geral')" id="btn-geral" class="tab-btn active px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-check-circle"></i> Validação Diária</button>
                <button onclick="mudarAba('performance')" id="btn-performance" class="tab-btn px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-trophy"></i> Performance</button>
                <button onclick="mudarAba('matriz')" id="btn-matriz" class="tab-btn px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-th"></i> Matriz Anual</button>
                <button onclick="mudarAba('consolidado')" id="btn-consolidado" class="tab-btn px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-table"></i> Consolidado</button>
            </div>
        </div>

        <div id="tab-geral" class="view-section animate-fade-in space-y-6">
            <div class="flex flex-wrap items-center justify-between gap-3 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                <div>
                    <input type="file" id="input-excel" accept=".xlsx, .csv" class="hidden" onchange="importarExcel(this)">
                    <button onclick="document.getElementById('input-excel').click()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-file-excel"></i> Importar Excel</button>
                    <span class="text-[10px] text-slate-400 block mt-1 ml-1">Arquivo: ddmmaaaa.xlsx</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                        <span class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">Ref</span>
                        <input type="text" id="data-validacao" class="w-24 bg-transparent text-center font-bold text-slate-700 outline-none text-sm cursor-pointer" placeholder="DD/MM/AAAA" maxlength="10">
                        <i class="fas fa-calendar-alt text-slate-400"></i>
                    </div>
                    <select id="view-mode" onchange="Geral.toggleSemana()" class="py-1.5 px-3 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 outline-none bg-slate-50 focus:border-blue-500 cursor-pointer">
                        <option value="dia">Apenas o Dia</option>
                        <option value="mes">Mês Inteiro</option>
                        <option value="semana">Por Semana</option>
                    </select>
                    <select id="select-semana" onchange="Geral.carregarTela()" class="hidden py-1.5 px-3 border border-blue-200 bg-blue-50 text-blue-800 rounded-lg text-sm font-bold outline-none cursor-pointer">
                        <option value="1">Semana 1</option><option value="2">Semana 2</option><option value="3">Semana 3</option><option value="4">Semana 4</option><option value="5">Semana 5</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative flex flex-col justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Equipe Considerada</p>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-black text-slate-800 tracking-tighter" id="kpi-hc">--</p>
                            <i class="fas fa-users text-4xl text-slate-100 group-hover:text-blue-50 transition"></i>
                        </div>
                    </div>
                    <div id="info-abonados" class="mt-2 text-[10px] font-bold bg-amber-50 text-amber-700 px-2 py-1 rounded hidden border border-amber-100"></div>
                    <p class="text-[10px] text-slate-400 mt-1" id="label-hc-desc">Ativos no Período</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Dias Trabalhados</p>
                    <div class="flex items-end justify-between"><p class="text-3xl font-black text-slate-800 tracking-tighter" id="kpi-dias">--</p><i class="fas fa-calendar-day text-4xl text-slate-100 group-hover:text-blue-50 transition"></i></div>
                    <p class="text-[10px] text-slate-400 mt-1" id="kpi-dias-label">Geral ou Individual</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Produção vs Meta</p>
                    <div class="flex items-end gap-2"><p class="text-3xl font-black text-blue-600 tracking-tighter" id="kpi-total">--</p><span class="text-xs font-bold text-slate-400 mb-1">/ <span id="kpi-meta-total">--</span></span></div>
                    <div class="w-full bg-slate-100 h-1.5 mt-2 rounded-full overflow-hidden"><div id="bar-prod" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Média / Analista</p>
                    <div class="flex items-end gap-2"><p class="text-3xl font-black text-emerald-600 tracking-tighter" id="kpi-media">--</p><span class="text-xs font-bold text-slate-400 mb-1">/ <span id="kpi-meta-media">--</span></span></div>
                    <div class="w-full bg-slate-100 h-1.5 mt-2 rounded-full overflow-hidden"><div id="bar-media" class="bg-emerald-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                </div>

                <div id="card-pct" class="bg-gradient-to-br from-indigo-600 to-blue-700 p-5 rounded-xl shadow-lg shadow-blue-200 group relative text-white transition-colors duration-500">
                    <p class="text-[10px] font-bold text-white/70 uppercase tracking-widest mb-1">Atingimento Global</p>
                    <div class="flex items-center justify-between">
                        <p class="text-4xl font-black tracking-tighter" id="kpi-pct">--%</p>
                        <div id="icon-pct" class="text-2xl text-white/80"><i class="fas fa-chart-pie"></i></div>
                    </div>
                    <p class="text-[10px] text-white/60 mt-2 font-medium" id="kpi-pct-detail">Real vs Esperado</p>
                </div>

            </div>

            <div id="selection-header" class="hidden bg-blue-50 border border-blue-100 p-3 rounded-lg flex justify-between items-center animate-fade-in">
                <span class="text-sm font-bold text-blue-800"><i class="fas fa-user-circle mr-2"></i> Exibindo dados de: <span id="selected-name" class="underline text-blue-900"></span></span>
                <button onclick="Geral.limparSelecao()" class="text-xs bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 font-bold shadow-sm"><i class="fas fa-times mr-1"></i> Limpar Filtro</button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs tracking-wide">
                            <tr>
                                <th class="px-4 py-4 text-center w-24">Fator</th>
                                <th class="px-6 py-4">Assistente</th>
                                <th class="px-6 py-4 text-center">Dias Calc.</th>
                                <th class="px-6 py-4 text-center">Total</th>
                                <th class="px-6 py-4 text-center">FIFO</th>
                                <th class="px-6 py-4 text-center">G. Total</th>
                                <th class="px-6 py-4 text-center">G. Parcial</th>
                                <th class="px-6 py-4 text-center">Meta Calc.</th>
                                <th class="px-6 py-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-corpo" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-performance" class="view-section hidden animate-fade-in space-y-6">
            <div class="flex flex-col md:flex-row justify-end items-center bg-white p-3 rounded-xl shadow-sm border border-slate-200 gap-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">Ref</span><input type="text" id="data-perf" class="w-24 bg-transparent text-center font-bold text-slate-700 outline-none text-sm" placeholder="DD/MM/AAAA" maxlength="10"></div>
                    <select id="perf-period-type" onchange="Perf.carregarRanking()" class="py-1.5 px-3 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 outline-none bg-slate-50 focus:border-blue-500 cursor-pointer"><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano">Anual</option></select>
                </div>
            </div>
            <div id="perf-view-individual">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1" id="perf-label-total">Total</p><p class="text-3xl font-black text-blue-700" id="perf-card-total">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média Diária</p><p class="text-3xl font-black text-slate-800" id="perf-card-media">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Meta Período</p><p class="text-3xl font-black text-slate-500" id="perf-card-meta">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 bg-gradient-to-br from-slate-50 to-white"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Ranking</p><div id="perf-rank-content" class="text-sm font-medium text-slate-700"></div></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-6">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-700">Ranking Detalhado</h3><button onclick="Perf.limparSelecao()" class="text-xs text-blue-600 hover:text-blue-800 font-bold hidden" id="perf-btn-limpar">✕ Limpar Seleção</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200"><tr><th class="px-6 py-3">#</th><th class="px-6 py-3">Assistente</th><th class="px-6 py-3 text-center text-blue-700 font-bold">Total</th><th class="px-6 py-3 text-center">Dias</th><th class="px-6 py-3 text-center">Média</th><th class="px-6 py-3 text-center">Meta Total</th><th class="px-6 py-3 text-center">% Meta</th></tr></thead><tbody id="perf-ranking-body" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="tab-matriz" class="view-section hidden animate-fade-in space-y-6">
            <div class="flex justify-between p-3 bg-white rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700">Visão Panorâmica</h3>
                <input type="text" id="data-matriz" class="w-24 bg-slate-50 text-center font-bold text-slate-700 outline-none text-sm p-1 rounded border border-slate-100" placeholder="DD/MM/AAAA" maxlength="10">
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-xs text-left"><tbody id="matriz-body"></tbody></table></div></div>
        </div>

        <div id="tab-consolidado" class="view-section hidden animate-fade-in space-y-6">
            <div class="flex justify-end p-3 bg-white rounded-xl shadow-sm border border-slate-200 gap-2">
                <input type="text" id="data-cons" class="w-24 bg-slate-50 text-center font-bold text-slate-700 outline-none text-sm p-1 rounded border border-slate-100" placeholder="DD/MM/AAAA" maxlength="10">
                <select id="cons-period-type" onchange="Cons.carregar()" class="text-sm font-bold text-slate-600 bg-transparent outline-none cursor-pointer"><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano_mes">Anual</option><option value="dia">Diário</option></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Produção Total</p><p class="text-3xl font-black text-blue-700" id="cons-p-total">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média do Time</p><p class="text-3xl font-black text-slate-800" id="cons-p-media-time">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden"><div class="absolute right-0 top-0 bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded-bl">Base 17</div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média (Base Fixa)</p><p class="text-3xl font-black text-amber-600" id="cons-p-media-ind">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Ativos</p><p class="text-3xl font-black text-slate-800" id="cons-p-headcount">0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead id="cons-table-header"></thead><tbody id="cons-table-body"></tbody></table></div></div>
        </div>
    </div>

    <script>
        const sessao = JSON.parse(localStorage.getItem('usuario'));
        const KEY_DATA_GLOBAL = 'data_sistema_global';

        function mudarAba(aba) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${aba}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${aba}`).classList.add('active');

            const dataAtual = localStorage.getItem(KEY_DATA_GLOBAL) || Sistema.Datas.formatar(new Date());
            if (aba === 'geral') { document.getElementById('data-validacao').value = dataAtual; Geral.carregarTela(); }
            if (aba === 'performance') { document.getElementById('data-perf').value = dataAtual; Perf.init(); }
            if (aba === 'matriz') { document.getElementById('data-matriz').value = dataAtual; Matriz.init(); }
            if (aba === 'consolidado') { document.getElementById('data-cons').value = dataAtual; Cons.init(); }
        }

        async function importarExcel(input) {
            const file = input.files[0];
            if (!file) return;
            const nomeArquivo = file.name;
            const matchData = nomeArquivo.match(/^(\d{2})(\d{2})(\d{4})/);
            if (!matchData) { alert("Nome inválido (ddmmaaaa.xlsx)"); input.value = ''; return; }
            const dataDoArquivo = `${matchData[3]}-${matchData[2]}-${matchData[1]}`;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    if (json.length === 0) return alert("Vazia.");

                    const usersMap = {};
                    const { data: users } = await _supabase.from('usuarios').select('id, nome');
                    users.forEach(u => usersMap[u.nome.trim().toLowerCase()] = u.id);

                    let inserts = [];
                    for (let row of json) {
                        const nomeCsv = row['assistente'];
                        const idCsv = row['id_assistente'];
                        if (!idCsv && !nomeCsv) continue;
                        if (String(nomeCsv).toLowerCase().includes('total')) continue;

                        let uid = idCsv;
                        if (!uid && nomeCsv && usersMap[nomeCsv.trim().toLowerCase()]) uid = usersMap[nomeCsv.trim().toLowerCase()];

                        if (uid) {
                            inserts.push({
                                usuario_id: uid, data_referencia: dataDoArquivo,
                                quantidade: row['documentos_validados'] || 0,
                                fifo: row['documentos_validados_fifo'] || 0,
                                gradual_total: row['documentos_validados_gradual_total'] || 0,
                                gradual_parcial: row['documentos_validados_gradual_parcial'] || 0,
                                perfil_fc: row['documentos_validados_perfil_fc'] || 0
                            });
                        }
                    }

                    if (inserts.length > 0) {
                        if(confirm(`Importar ${inserts.length} registros para ${matchData[1]}/${matchData[2]}/${matchData[3]}?`)) {
                            const { error } = await _supabase.from('producao').upsert(inserts, { onConflict: 'usuario_id, data_referencia' });
                            if (error) throw error;
                            alert("Sucesso!");
                            localStorage.setItem(KEY_DATA_GLOBAL, `${matchData[1]}/${matchData[2]}/${matchData[3]}`);
                            mudarAba('geral');
                        }
                    } else alert("Dados inválidos.");
                } catch (err) { alert("Erro: " + err.message); } finally { input.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        }

        const Geral = {
            listaAtual: [],
            selecionado: null,
            dataVisualizada: null,
            periodoInicio: null,
            periodoFim: null,

            toggleSemana: function() {
                const mode = document.getElementById('view-mode').value;
                const selSemana = document.getElementById('select-semana');
                if (mode === 'semana') selSemana.classList.remove('hidden'); else selSemana.classList.add('hidden');
                this.carregarTela();
            },
            
            carregarTela: async function() {
                const modo = document.getElementById('view-mode').value;
                const refDate = Sistema.Datas.lerInput('data-validacao');
                const isoDate = refDate.toISOString().split('T')[0];
                this.dataVisualizada = isoDate; 

                // Definição dos limites do período para cálculo de metas
                let inicio, fim;
                if (modo === 'dia') { 
                    inicio = isoDate; fim = isoDate; 
                } else { 
                    const ano = refDate.getFullYear(); const mes = refDate.getMonth();
                    inicio = new Date(ano, mes, 1).toISOString().split('T')[0];
                    fim = new Date(ano, mes + 1, 0).toISOString().split('T')[0];
                }

                // Armazena para uso no renderizar
                this.periodoInicio = inicio;
                this.periodoFim = fim;

                const { data } = await _supabase.from('producao').select('*').gte('data_referencia', inicio).lte('data_referencia', fim);
                let dadosFiltrados = data || [];
                
                if (modo === 'semana') {
                    const numSemana = parseInt(document.getElementById('select-semana').value);
                    dadosFiltrados = dadosFiltrados.filter(d => Sistema.Datas.getSemanaDoMes(d.data_referencia) === numSemana);
                    
                    // Ajustar inicio e fim do período para a semana selecionada (aproximado pelos dados ou lógica de semana)
                    // Como não temos a lógica exata de limites da semana aqui, vamos filtrar os dias úteis na renderização
                    // Mas precisamos garantir que this.periodoInicio/Fim reflitam a semana para o cálculo de meta
                    // Simplificação: vamos calcular meta baseada nos dias encontrados OU recalcular limites da semana
                    // Para precisão, o ideal seria ter uma função getDatesOfWeek(mes, semana).
                    // Vou assumir que o filtro visual já basta, e no renderizar contaremos dias úteis entre o menor e maior dia da semana encontrada nos dados
                    // Se não houver dados na semana, a meta será 0.
                }

                this.listaAtual = Sistema.Dados.normalizar(dadosFiltrados);
                this.renderizar();
            },

            // Função auxiliar para contar dias úteis (Seg-Sex)
            contarDiasUteis: function(inicioStr, fimStr) {
                if(!inicioStr || !fimStr) return 1;
                let count = 0;
                let cur = new Date(inicioStr + 'T12:00:00');
                const end = new Date(fimStr + 'T12:00:00');
                while(cur <= end) {
                    const d = cur.getDay();
                    if(d !== 0 && d !== 6) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                return count || 1;
            },

            mudarFator: function(nome, valor) {
                const modo = document.getElementById('view-mode').value;
                if (modo !== 'dia') {
                    alert("Atenção: Altere o fator apenas visualizando o 'Dia' específico.");
                    this.renderizar(); 
                    return;
                }
                Sistema.Dados.definirFator(nome, this.dataVisualizada, valor);
                this.carregarTela();
            },

            selecionar: function(nome) {
                if (this.selecionado === nome) this.selecionado = null; else this.selecionado = nome;
                this.renderizar();
            },
            limparSelecao: function() { this.selecionado = null; this.renderizar(); },

            renderizar: function() {
                const tbody = document.getElementById('tabela-corpo'); tbody.innerHTML = '';
                const modo = document.getElementById('view-mode').value;

                // 1. Filtragem de Ativos
                const ativos = this.listaAtual.filter(u => !u.inativo);
                
                const baseCalculo = this.selecionado 
                    ? this.listaAtual.filter(u => u.nome === this.selecionado) 
                    : ativos;

                const totalProd = baseCalculo.reduce((a, b) => a + b.total, 0);
                
                // --- CÁLCULO DE META DINÂMICA (Baseado em Dias Úteis do Período) ---
                let diasUteisPeriodo = 1;
                if(modo === 'dia') {
                    diasUteisPeriodo = 1;
                } else if (modo === 'mes') {
                    diasUteisPeriodo = this.contarDiasUteis(this.periodoInicio, this.periodoFim);
                } else if (modo === 'semana') {
                    // Para semana, tentamos pegar o range dos dados ou estimar 5 dias se tiver dados
                    // Se houver dados, pegamos min e max data
                    if(this.listaAtual.length > 0) {
                        // Encontrar todas as datas presentes
                        let todasDatas = new Set();
                        this.listaAtual.forEach(u => Object.keys(u.diasMap).forEach(d => todasDatas.add(d)));
                        let datasArr = Array.from(todasDatas).sort();
                        if(datasArr.length > 0) {
                            diasUteisPeriodo = this.contarDiasUteis(datasArr[0], datasArr[datasArr.length-1]);
                        } else diasUteisPeriodo = 5; // Fallback
                    } else diasUteisPeriodo = 5;
                }

                const hcConsiderado = this.selecionado ? 1 : ativos.length;
                const metaDiaria = 650;
                
                // Meta Total Esperada para o Período Selecionado
                // Ex: Mês (22 dias) * 10 Pessoas * 650 = 143.000
                const metaTotalEsperada = diasUteisPeriodo * hcConsiderado * metaDiaria;

                // Meta para Média Individual
                // Ex: Mês (22 dias) * 650 = 14.300 por pessoa
                const metaMediaIndividual = diasUteisPeriodo * metaDiaria;

                // Média Real (Por Analista)
                // Quanto cada analista entregou em média neste período
                const mediaRealAnalista = hcConsiderado ? Math.round(totalProd / hcConsiderado) : 0;
                
                // --- CARD 1: EQUIPE ---
                let diasDisplay = 0;
                let diasLabel = "";
                if (this.selecionado) {
                    diasDisplay = baseCalculo.length ? baseCalculo[0].dias : 0; 
                    diasLabel = "Dias do Colaborador (Considera 50%)";
                } else {
                    const setDiasUnicos = new Set();
                    ativos.forEach(u => {
                        if (u.diasMap) { Object.entries(u.diasMap).forEach(([data, info]) => { if (info.fator > 0) setDiasUnicos.add(data); }); }
                    });
                    diasDisplay = setDiasUnicos.size;
                    diasLabel = "Dias Úteis da Equipe (Calendário)";
                }

                // Lógica de Abonados
                const elInfoAbonados = document.getElementById('info-abonados');
                elInfoAbonados.classList.add('hidden'); 
                if (modo === 'dia' && !this.selecionado) {
                    let qtdMeio = 0, qtdAbonado = 0;
                    this.listaAtual.forEach(u => {
                        const diaInfo = u.diasMap[this.dataVisualizada];
                        if (diaInfo) { if (diaInfo.fator === 0.5) qtdMeio++; else if (diaInfo.fator === 0) qtdAbonado++; }
                    });
                    if (qtdMeio > 0 || qtdAbonado > 0) {
                        let texto = [];
                        if (qtdMeio > 0) texto.push(`${qtdMeio} Meio Período`);
                        if (qtdAbonado > 0) texto.push(`${qtdAbonado} Abonado(s)`);
                        elInfoAbonados.innerText = texto.join(', ');
                        elInfoAbonados.classList.remove('hidden');
                    }
                }

                // Atualização dos Cards
                document.getElementById('kpi-hc').innerText = hcConsiderado;
                document.getElementById('kpi-dias').innerText = diasDisplay;
                document.getElementById('kpi-dias-label').innerText = diasLabel;
                
                // Card Produção vs Meta
                document.getElementById('kpi-total').innerText = totalProd.toLocaleString();
                document.getElementById('kpi-meta-total').innerText = metaTotalEsperada.toLocaleString();
                document.getElementById('bar-prod').style.width = Math.min((totalProd/(metaTotalEsperada||1))*100, 100) + '%';

                // Card Média / Analista
                document.getElementById('kpi-media').innerText = mediaRealAnalista.toLocaleString();
                document.getElementById('kpi-meta-media').innerText = metaMediaIndividual.toLocaleString();
                document.getElementById('bar-media').style.width = Math.min((mediaRealAnalista/(metaMediaIndividual||1))*100, 100) + '%';

                // Card Atingimento (%)
                const percentual = metaTotalEsperada > 0 ? Math.round((totalProd / metaTotalEsperada) * 100) : 0;
                document.getElementById('kpi-pct').innerText = percentual + '%';
                document.getElementById('kpi-pct-detail').innerText = `${totalProd.toLocaleString()} / ${metaTotalEsperada.toLocaleString()}`;
                
                const cardPct = document.getElementById('card-pct');
                const iconPct = document.getElementById('icon-pct');
                cardPct.classList.remove('from-indigo-600', 'to-blue-700', 'from-red-600', 'to-rose-700', 'shadow-blue-200', 'shadow-rose-200');

                if (percentual < 100) {
                    cardPct.classList.add('from-red-600', 'to-rose-700', 'shadow-rose-200');
                    iconPct.innerHTML = '<i class="fas fa-times-circle text-white/50"></i>';
                } else {
                    cardPct.classList.add('from-indigo-600', 'to-blue-700', 'shadow-blue-200');
                    iconPct.innerHTML = '<i class="fas fa-check-circle text-white/50"></i>';
                }

                // Cabeçalho de seleção e Tabela (sem alterações lógicas, apenas renderização)
                const selHeader = document.getElementById('selection-header');
                if (this.selecionado) { selHeader.classList.remove('hidden'); document.getElementById('selected-name').innerText = this.selecionado; } 
                else selHeader.classList.add('hidden');

                if(this.listaAtual.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-10 text-slate-400">Sem dados.</td></tr>'; return; }

                this.listaAtual.forEach(u => {
                    const isSelected = this.selecionado === u.nome;
                    const rowClass = isSelected ? "selected-row" : "hover:bg-slate-50";
                    const opacity = u.inativo ? "row-ignored" : "";
                    const badge = u.atingiu ? '<span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded text-xs font-bold">Atingida</span>' : '<span class="bg-rose-100 text-rose-800 px-2 py-1 rounded text-xs font-bold">Abaixo</span>';
                    const subIds = u.ids.length > 1 ? `<br><span class="text-[9px] text-slate-400">IDs: ${u.ids.join(', ')}</span>` : '';

                    let fator = 1;
                    if (modo === 'dia') {
                         const infoDia = u.diasMap[this.dataVisualizada];
                         fator = infoDia ? infoDia.fator : 1;
                    } else {
                         if (u.dias === 0) fator = 0; else if (u.dias % 1 !== 0) fator = 0.5;
                    }
                    const fatorClass = fator === 1 ? 'st-1' : (fator === 0.5 ? 'st-05' : 'st-0');
                    const disabled = modo !== 'dia' ? 'disabled opacity-50 cursor-not-allowed' : '';

                    const selectHtml = `
                    <select class="status-select ${fatorClass} ${disabled}" onclick="event.stopPropagation()" onchange="Geral.mudarFator('${u.nome}', this.value)">
                        <option value="1" ${fator===1?'selected':''}>100%</option>
                        <option value="0.5" ${fator===0.5?'selected':''}>50%</option>
                        <option value="0" ${fator===0?'selected':''}>0%</option>
                    </select>`;

                    tbody.innerHTML += `<tr class="${rowClass} ${opacity} transition border-b border-slate-100 cursor-pointer"><td class="px-4 py-4 text-center">${selectHtml}</td><td class="px-6 py-4 font-bold text-slate-700" onclick="Geral.selecionar('${u.nome}')">${u.nome} ${subIds}</td><td class="px-6 py-4 text-center text-slate-500">${u.dias}</td><td class="px-6 py-4 text-center font-bold text-blue-700">${u.total.toLocaleString()}</td><td class="px-6 py-4 text-center text-slate-600">${u.fifo}</td><td class="px-6 py-4 text-center text-slate-600">${u.gt}</td><td class="px-6 py-4 text-center text-slate-600">${u.gp}</td><td class="px-6 py-4 text-center text-slate-400">${u.meta.toLocaleString()}</td><td class="px-6 py-4 text-center">${badge}</td></tr>`;
                });
            }
        };

        const Perf = {
            selectedUserId: null, dadosCarregados: [], initialized: false,
            init: function() { if(!this.initialized) { Sistema.Datas.criarInputInteligente('data-perf', KEY_DATA_GLOBAL, () => { this.carregarRanking(); }); this.initialized = true; } this.carregarRanking(); },
            limparSelecao: function() { this.selectedUserId = null; document.getElementById('perf-btn-limpar').classList.add('hidden'); this.carregarRanking(); },
            toggleUsuario: function(id) { if (this.selectedUserId === id) { this.selectedUserId = null; document.getElementById('perf-btn-limpar').classList.add('hidden'); } else { this.selectedUserId = id; document.getElementById('perf-btn-limpar').classList.remove('hidden'); } this.renderRanking(); },
            carregarRanking: async function() {
                const tbody = document.getElementById('perf-ranking-body'); tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">A carregar dados...</td></tr>';
                try {
                    const tipo = document.getElementById('perf-period-type').value; 
                    const refDate = Sistema.Datas.lerInput('data-perf');
                    const ano = refDate.getFullYear(); const mes = refDate.getMonth() + 1;
                    let s, e;
                    if (tipo === 'mes') { s = `${ano}-${String(mes).padStart(2,'0')}-01`; e = `${ano}-${String(mes).padStart(2,'0')}-${new Date(ano, mes, 0).getDate()}`; }
                    else if (tipo === 'trimestre') { const trim = Math.ceil(mes / 3); const mStart = ((trim-1)*3)+1; const mEnd = mStart+2; s = `${ano}-${String(mStart).padStart(2,'0')}-01`; e = `${ano}-${String(mEnd).padStart(2,'0')}-${new Date(ano, mEnd, 0).getDate()}`; }
                    else if (tipo === 'semestre') { const sem = Math.ceil(mes / 6); s = sem === 1 ? `${ano}-01-01` : `${ano}-07-01`; e = sem === 1 ? `${ano}-06-30` : `${ano}-12-31`; } else { s = `${ano}-01-01`; e = `${ano}-12-31`; }
                    const { data: prods, error } = await _supabase.from('producao').select('*, usuarios(nome, funcao)').gte('data_referencia', s).lte('data_referencia', e); if(error) throw error;
                    let stats = {};
                    prods.forEach(item => {
                        if (!item.usuarios || item.usuarios.funcao !== 'Assistente') return;
                        const uid = item.usuario_id;
                        if (!stats[uid]) stats[uid] = { id: uid, nome: item.usuarios.nome, total: 0, dias: new Set() };
                        stats[uid].total += (Number(item.quantidade) || 0); stats[uid].dias.add(item.data_referencia);
                    });
                    this.dadosCarregados = Object.values(stats).sort((a, b) => b.total - a.total);
                    this.renderRanking();
                } catch (err) { console.error(err); tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-400">Erro.</td></tr>'; }
            },
            renderRanking: function() {
                const tbody = document.getElementById('perf-ranking-body'); if (!this.dadosCarregados.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">Nenhum dado.</td></tr>'; this.atualizarCards(null); return; }
                let html = ''; let userStats = null;
                this.dadosCarregados.forEach((u, idx) => {
                    const dias = u.dias.size || 1; const media = Math.round(u.total / dias); const meta = 650 * dias; const pct = Math.round((u.total / meta) * 100);
                    const isSelected = this.selectedUserId === u.id; if (isSelected) userStats = { ...u, media, meta, rank: idx + 1 };
                    const isMe = sessao && u.id === sessao.id; let rowClass = "hover:bg-slate-50 transition border-b border-slate-100 cursor-pointer "; if (isSelected) rowClass += "selected-row"; else if (isMe) rowClass += "me-row";
                    let badgeClass = pct >= 100 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800';
                    html += `<tr class="${rowClass}" onclick="Perf.toggleUsuario(${u.id})"><td class="px-6 py-4 font-bold text-slate-400">#${idx + 1}</td><td class="px-6 py-4 font-medium">${u.nome} ${isMe ? '(Você)' : ''}</td><td class="px-6 py-4 text-center font-bold text-blue-700">${u.total.toLocaleString()}</td><td class="px-6 py-4 text-center text-slate-500">${dias}</td><td class="px-6 py-4 text-center font-medium">${media.toLocaleString()}</td><td class="px-6 py-4 text-center text-slate-400">${meta.toLocaleString()}</td><td class="px-6 py-4 text-center"><span class="${badgeClass} text-xs font-bold px-2 py-1 rounded-full">${pct}%</span></td></tr>`;
                });
                tbody.innerHTML = html; this.atualizarCards(userStats);
            },
            atualizarCards: function(userStats) {
                if (userStats) {
                    document.getElementById('perf-label-total').innerText = "Total (" + userStats.nome.split(' ')[0] + ")"; document.getElementById('perf-card-total').innerText = userStats.total.toLocaleString(); document.getElementById('perf-card-media').innerText = userStats.media.toLocaleString(); document.getElementById('perf-card-meta').innerText = userStats.meta.toLocaleString(); 
                } else {
                    const totalGeral = this.dadosCarregados.reduce((acc, curr) => acc + curr.total, 0); const diasGeral = this.dadosCarregados.reduce((acc, curr) => acc + (curr.dias.size||1), 0); const metaGeral = 650 * diasGeral; const mediaGeral = diasGeral ? Math.round(totalGeral / diasGeral) : 0;
                    document.getElementById('perf-label-total').innerText = "Total (Time)"; document.getElementById('perf-card-total').innerText = totalGeral.toLocaleString(); document.getElementById('perf-card-media').innerText = mediaGeral.toLocaleString(); document.getElementById('perf-card-meta').innerText = metaGeral.toLocaleString(); 
                    let topHtml = '<div class="flex flex-col gap-1">'; this.dadosCarregados.slice(0, 3).forEach((u, i) => { topHtml += `<div class="flex justify-between text-xs"><span class="font-bold text-slate-600">#${i+1} ${u.nome.split(' ')[0]}</span> <span class="text-blue-600 font-bold">${u.total.toLocaleString()}</span></div>`; }); topHtml += '</div>'; document.getElementById('perf-rank-content').innerHTML = topHtml;
                }
            }
        };

        const Matriz = {
            initialized: false,
            init: function() { if(!this.initialized) { Sistema.Datas.criarInputInteligente('data-matriz', KEY_DATA_GLOBAL, () => { this.carregar(); }); this.initialized = true; } this.carregar(); },
            carregar: async function() {
                const tbody = document.getElementById('matriz-body'); tbody.innerHTML = '<tr><td colspan="20" class="text-center py-8 text-slate-400">A calcular...</td></tr>';
                try {
                    const ano = Sistema.Datas.lerInput('data-matriz').getFullYear();
                    const { data: prods, error } = await _supabase.from('producao').select('*, usuarios(nome, funcao)').gte('data_referencia', `${ano}-01-01`).lte('data_referencia', `${ano}-12-31`);
                    if(error) throw error;
                    let map = {};
                    prods.forEach(item => {
                        if (!item.usuarios || item.usuarios.funcao !== 'Assistente') return;
                        const uid = item.usuario_id;
                        if (!map[uid]) map[uid] = { nome: item.usuarios.nome, m: Array(12).fill(0), t: 0 };
                        const mes = new Date(item.data_referencia + 'T12:00:00').getMonth(); map[uid].m[mes] += (Number(item.quantidade)||0); map[uid].t += (Number(item.quantidade)||0);
                    });
                    const lista = Object.values(map).sort((a, b) => b.t - a.t);
                    let html = '';
                    lista.forEach(u => {
                        const q1 = u.m[0]+u.m[1]+u.m[2]; const q2 = u.m[3]+u.m[4]+u.m[5]; const s1 = q1+q2; const q3 = u.m[6]+u.m[7]+u.m[8]; const q4 = u.m[9]+u.m[10]+u.m[11]; const s2 = q3+q4; const cell = (v) => v ? v.toLocaleString() : '-';
                        html += `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="px-4 py-3 font-bold text-slate-700 sticky left-0 bg-white border-r border-slate-200 z-10">${u.nome}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[0])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[1])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[2])}</td><td class="col-tri">${cell(q1)}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[3])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[4])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[5])}</td><td class="col-tri">${cell(q2)}</td><td class="col-sem">${cell(s1)}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[6])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[7])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[8])}</td><td class="col-tri">${cell(q3)}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[9])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[10])}</td><td class="px-2 py-3 text-center text-slate-600">${cell(u.m[11])}</td><td class="col-tri">${cell(q4)}</td><td class="col-sem">${cell(s2)}</td><td class="col-ano">${u.t.toLocaleString()}</td></tr>`;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="20" class="text-center py-4">Sem dados.</td></tr>';
                } catch(e) { console.error(e); }
            }
        };

        const Cons = {
            initialized: false,
            init: function() { if(!this.initialized) { Sistema.Datas.criarInputInteligente('data-cons', KEY_DATA_GLOBAL, () => { this.carregar(); }); this.initialized = true; } this.carregar(); },
            carregar: async function() {
                const tbody = document.getElementById('cons-table-body'); tbody.innerHTML = '<tr><td colspan="15" class="text-center py-8 text-slate-400">A calcular indicadores...</td></tr>';
                const t = document.getElementById('cons-period-type').value; 
                const refDate = Sistema.Datas.lerInput('data-cons');
                const ano = refDate.getFullYear(); const mes = refDate.getMonth() + 1;
                let s, e;
                if (t === 'dia') { const iso = refDate.toISOString().split('T')[0]; s = iso; e = iso; }
                else if (t === 'mes') { s = `${ano}-${String(mes).padStart(2,'0')}-01`; e = `${ano}-${String(mes).padStart(2,'0')}-${new Date(ano, mes, 0).getDate()}`; }
                else if (t === 'trimestre') { const trim = Math.ceil(mes / 3); const mStart = ((trim-1)*3)+1; const mEnd = mStart+2; s = `${ano}-${String(mStart).padStart(2,'0')}-01`; e = `${ano}-${String(mEnd).padStart(2,'0')}-${new Date(ano, mEnd, 0).getDate()}`; }
                else if (t === 'semestre') { const sem = Math.ceil(mes / 6); s = sem === 1 ? `${ano}-01-01` : `${ano}-07-01`; e = sem === 1 ? `${ano}-06-30` : `${ano}-12-31`; } else { s = `${ano}-01-01`; e = `${ano}-12-31`; }

                try {
                    const { data: rawData, error } = await _supabase.from('producao').select('*, usuarios(funcao, contrato)').gte('data_referencia', s).lte('data_referencia', e); if(error) throw error;
                    
                    let cols = []; if (t === 'dia') cols = ['Dia']; else if (t === 'mes') cols = ['S1','S2','S3','S4','S5']; else if (t === 'trimestre') cols = ['Mês 1','Mês 2','Mês 3']; else if (t === 'semestre') cols = ['M1','M2','M3','M4','M5','M6']; else cols = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                    const numCols = cols.length; let st = {}; for(let i=1; i<=numCols; i++) st[i] = this.newStats(); st[99] = this.newStats();
                    
                    rawData.forEach(r => {
                        if(!r.usuarios || r.usuarios.funcao !== 'Assistente') return;
                        let b = 1; const dt = new Date(r.data_referencia + 'T12:00:00');
                        if(t === 'mes') { const firstDay = new Date(dt.getFullYear(), dt.getMonth(), 1).getDay(); b = Math.ceil((dt.getDate() + firstDay) / 7); }
                        else if (t === 'trimestre') b = (dt.getMonth() % 3) + 1; else if (t === 'semestre') b = (dt.getMonth() % 6) + 1; else if (t === 'ano_mes') b = dt.getMonth() + 1;
                        if(b > numCols) b = numCols;
                        const sys = Number(r.quantidade) || 0;
                        [b, 99].forEach(k => {
                            if(!st[k]) return; const x = st[k];
                            x.users.add(r.usuario_id); x.dates.add(r.data_referencia); x.qty += sys; x.fifo += (Number(r.fifo)||0); x.gt += (Number(r.gradual_total)||0); x.gp += (Number(r.gradual_parcial)||0); x.fc += (Number(r.perfil_fc)||0);
                            if (r.usuarios.contrato && r.usuarios.contrato.includes('CLT')) { x.clt_users.add(r.usuario_id); x.clt_qty += sys; } else { x.pj_users.add(r.usuario_id); x.pj_qty += sys; }
                        });
                    });

                    const hRow = document.getElementById('cons-table-header'); hRow.innerHTML = `<th class="px-4 py-3 sticky left-0 bg-slate-50 z-20 border-r border-slate-200">Indicadores</th>` + cols.map(c => `<th class="px-4 py-3 text-center border-l border-slate-100">${c}</th>`).join('') + `<th class="px-4 py-3 text-center bg-blue-50 text-blue-800 border-l border-blue-100">TOTAL</th>`;
                    let h = ''; const idxs = [...Array(numCols).keys()].map(i => i + 1); idxs.push(99);
                    const mkRow = (label, getter, isCalc=false, isBold=false, isSub=false) => {
                        const rowClass = isBold ? 'row-total' : (isSub ? 'row-sub' : 'hover:bg-slate-50'); let tr = `<tr class="${rowClass} border-b border-slate-100"><td class="px-4 py-3 font-medium col-fixed">${label}</td>`;
                        idxs.forEach(i => {
                            const s = st[i]; const dias = s.dates.size || 1; const ativos = s.users.size || 1; const ac = s.clt_users.size || 1; const ap = s.pj_users.size || 1;
                            let val = 0; if (!isCalc) { val = getter(s); if (val instanceof Set) val = val.size; } else { val = getter(s, dias, ativos, ac, ap); }
                            const txt = val ? Math.round(val).toLocaleString() : (isBold ? '0' : '-'); const cellClass = i === 99 ? 'bg-blue-50 font-bold border-l border-blue-100 text-blue-900' : 'text-center border-l border-slate-50'; tr += `<td class="${cellClass} px-2 py-2">${txt}</td>`;
                        });
                        return tr + '</tr>';
                    };
                    const HF = 17;
                    h += mkRow('Ativos', s => s.users); h += mkRow('Dias Trabalhados', s => s.dates); h += mkRow('FIFO', s => s.fifo); h += mkRow('G. Parcial', s => s.gp); h += mkRow('G. Total', s => s.gt); h += mkRow('Perfil FC', s => s.fc); h += mkRow('Produção Total', s => s.qty, false, true);
                    h += mkRow('Média Diária (Time)', (s, d) => s.qty / d, true); h += mkRow(`Média/Assist (Base ${HF})`, (s) => s.qty / HF, true); h += mkRow(`Média Dia/Assist (Base ${HF})`, (s, d) => s.qty / d / HF, true);
                    h += `<tr><td colspan="${numCols + 2}" class="px-4 py-6 bg-slate-50 font-bold text-slate-400 text-xs uppercase tracking-widest text-center border-y border-slate-200">Segmentação por Contrato</td></tr>`;
                    h += mkRow('Produção CLT', s => s.clt_qty); h += mkRow('Média Diária/CLT', (s, d, a, ac) => s.clt_qty / d / ac, true);
                    h += mkRow('Produção PJ', s => s.pj_qty); h += mkRow('Média Diária/PJ', (s, d, a, ac, ap) => s.pj_qty / d / ap, true);
                    tbody.innerHTML = h;
                    
                    const tot = st[99]; const dTot = tot.dates.size || 1; 
                    document.getElementById('cons-p-total').innerText = tot.qty.toLocaleString(); 
                    document.getElementById('cons-p-media-time').innerText = Math.round(tot.qty / dTot).toLocaleString(); 
                    document.getElementById('cons-p-media-ind').innerText = Math.round(tot.qty / dTot / HF).toLocaleString(); 
                    document.getElementById('cons-p-headcount').innerText = tot.users.size;
                } catch (e) { console.error(e); }
            },
            newStats: function() { return { users: new Set(), dates: new Set(), qty: 0, fifo: 0, gt: 0, gp: 0, fc: 0, clt_users: new Set(), clt_qty: 0, pj_users: new Set(), pj_qty: 0 }; }
        };

        // --- INICIALIZAÇÃO GLOBAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            Sistema.Datas.criarInputInteligente('data-validacao', KEY_DATA_GLOBAL, Geral.carregarTela);
            await Sistema.Dados.inicializar(); 
            Geral.carregarTela();
        });
    </script>
</body>
</html>