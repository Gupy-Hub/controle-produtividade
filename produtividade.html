<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Produtividade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style> 
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; } 
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #2563eb; border-color: #2563eb; background-color: #eff6ff; }
        .tab-btn:not(.active) { color: #64748b; }
        .tab-btn:not(.active):hover { color: #334155; background-color: #f8fafc; }
        .selected-row { background-color: #eff6ff !important; border-left: 4px solid #2563eb; }
        .row-ignored { opacity: 0.6; background-color: #f8fafc; filter: grayscale(0.8); }
        .col-tri { background-color: #f0f9ff; color: #0369a1; font-weight: bold; text-align: center; border-left: 1px solid #e0f2fe; }
        .col-sem { background-color: #e0f2fe; color: #075985; font-weight: 800; text-align: center; border-left: 2px solid #bae6fd; }
        .col-ano { background-color: #0f172a; color: #ffffff; font-weight: 800; text-align: center; border-left: 2px solid #cbd5e1; }
        .col-fixed { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #e2e8f0; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .status-select { 
            background: transparent; font-weight: bold; font-size: 0.75rem; 
            padding: 2px 6px; border-radius: 6px; cursor: pointer; outline: none;
            transition: all 0.2s;
        }
        .st-1 { color: #15803d; background-color: #dcfce7; border: 1px solid #86efac; } 
        .st-05 { color: #a16207; background-color: #fef9c3; border: 1px solid #fde047; } 
        .st-0 { color: #b91c1c; background-color: #fee2e2; border: 1px solid #fca5a5; } 
    </style>
</head>
<body class="text-slate-800">
    <script src="js/config.js"></script>
    <script src="js/sistema.js"></script> 
    <script src="js/layout.js"></script>

    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Painel de Gestão</h1>
                <p class="text-slate-500 text-sm font-medium">Validação e Indicadores.</p>
            </div>
            
            <div class="bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm flex overflow-x-auto max-w-full">
                <button onclick="mudarAba('geral')" id="btn-geral" class="tab-btn active px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-check-circle"></i> Validação Diária</button>
                <button onclick="mudarAba('performance')" id="btn-performance" class="tab-btn px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-trophy"></i> Performance</button>
                <button onclick="mudarAba('matriz')" id="btn-matriz" class="tab-btn px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-th"></i> Matriz Anual</button>
                <button onclick="mudarAba('consolidado')" id="btn-consolidado" class="tab-btn px-4 py-2 text-sm font-bold rounded-lg flex items-center gap-2"><i class="fas fa-table"></i> Consolidado</button>
            </div>
        </div>

        <div id="tab-geral" class="view-section animate-fade-in space-y-6">
            <div class="flex flex-wrap items-center justify-between gap-3 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                <div>
                    <input type="file" id="input-excel" accept=".xlsx, .csv" class="hidden" onchange="importarExcel(this)">
                    <button onclick="document.getElementById('input-excel').click()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-file-excel"></i> Importar Excel</button>
                    <span class="text-[10px] text-slate-400 block mt-1 ml-1">Arquivo: ddmmaaaa.xlsx</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                        <span class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">Ref</span>
                        <input type="text" id="data-validacao" class="w-24 bg-transparent text-center font-bold text-slate-700 outline-none text-sm cursor-pointer" placeholder="DD/MM/AAAA" maxlength="10">
                        <i class="fas fa-calendar-alt text-slate-400"></i>
                    </div>
                    <select id="view-mode" onchange="Geral.toggleSemana()" class="py-1.5 px-3 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 outline-none bg-slate-50 focus:border-blue-500 cursor-pointer">
                        <option value="dia">Apenas o Dia</option>
                        <option value="mes">Mês Inteiro</option>
                        <option value="semana">Por Semana</option>
                    </select>
                    <select id="select-semana" onchange="Geral.carregarTela()" class="hidden py-1.5 px-3 border border-blue-200 bg-blue-50 text-blue-800 rounded-lg text-sm font-bold outline-none cursor-pointer">
                        <option value="1">Semana 1</option><option value="2">Semana 2</option><option value="3">Semana 3</option><option value="4">Semana 4</option><option value="5">Semana 5</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative flex flex-col justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Equipe Considerada</p>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-black text-slate-800 tracking-tighter" id="kpi-hc">--</p>
                            <i class="fas fa-users text-4xl text-slate-100 group-hover:text-blue-50 transition"></i>
                        </div>
                    </div>
                    <div id="info-abonados" class="mt-2 text-[10px] font-bold bg-amber-50 text-amber-700 px-2 py-1 rounded hidden border border-amber-100"></div>
                    <p class="text-[10px] text-slate-400 mt-1" id="label-hc-desc">Ativos no Período</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Dias Trabalhados</p>
                    <div class="flex items-end justify-between"><p class="text-3xl font-black text-slate-800 tracking-tighter" id="kpi-dias">--</p><i class="fas fa-calendar-day text-4xl text-slate-100 group-hover:text-blue-50 transition"></i></div>
                    <p class="text-[10px] text-slate-400 mt-1" id="kpi-dias-label">Geral ou Individual</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Produção vs Meta</p>
                    <div class="flex items-end gap-2"><p class="text-3xl font-black text-blue-600 tracking-tighter" id="kpi-total">--</p><span class="text-xs font-bold text-slate-400 mb-1">/ <span id="kpi-meta-total">--</span></span></div>
                    <div class="w-full bg-slate-100 h-1.5 mt-2 rounded-full overflow-hidden"><div id="bar-prod" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 group relative">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Média / Analista</p>
                    <div class="flex items-end gap-2"><p class="text-3xl font-black text-emerald-600 tracking-tighter" id="kpi-media">--</p><span class="text-xs font-bold text-slate-400 mb-1">/ <span id="kpi-meta-media">--</span></span></div>
                    <div class="w-full bg-slate-100 h-1.5 mt-2 rounded-full overflow-hidden"><div id="bar-media" class="bg-emerald-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                </div>

                <div id="card-pct" class="bg-gradient-to-br from-indigo-600 to-blue-700 p-5 rounded-xl shadow-lg shadow-blue-200 group relative text-white transition-colors duration-500">
                    <p class="text-[10px] font-bold text-white/70 uppercase tracking-widest mb-1">Atingimento Global</p>
                    <div class="flex items-center justify-between">
                        <p class="text-4xl font-black tracking-tighter" id="kpi-pct">--%</p>
                        <div id="icon-pct" class="text-2xl text-white/80"><i class="fas fa-chart-pie"></i></div>
                    </div>
                    <p class="text-[10px] text-white/60 mt-2 font-medium" id="kpi-pct-detail">Real vs Esperado</p>
                </div>

            </div>

            <div id="selection-header" class="hidden bg-blue-50 border border-blue-100 p-3 rounded-lg flex justify-between items-center animate-fade-in">
                <span class="text-sm font-bold text-blue-800"><i class="fas fa-user-circle mr-2"></i> Exibindo dados de: <span id="selected-name" class="underline text-blue-900"></span></span>
                <button onclick="Geral.limparSelecao()" class="text-xs bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 font-bold shadow-sm"><i class="fas fa-times mr-1"></i> Limpar Filtro</button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs tracking-wide">
                            <tr>
                                <th class="px-4 py-2 text-center w-28 bg-slate-100/50 border-r border-slate-200">
                                    <div class="flex flex-col items-center gap-1">
                                        <span class="text-[10px] text-slate-400">Ação em Massa</span>
                                        <select id="bulk-fator" onchange="Geral.mudarFatorTodos(this.value)" class="w-full text-[10px] bg-white border border-slate-300 rounded p-1 font-bold text-slate-700 outline-none cursor-pointer hover:border-blue-400 focus:border-blue-500 transition">
                                            <option value="">Aplicar...</option>
                                            <option value="1">Todos 100%</option>
                                            <option value="0.5">Todos 50%</option>
                                            <option value="0">Todos Abonar</option>
                                        </select>
                                    </div>
                                </th>
                                <th class="px-6 py-4">Assistente</th>
                                <th class="px-6 py-4 text-center">Dias Calc.</th>
                                <th class="px-6 py-4 text-center">Total</th>
                                <th class="px-6 py-4 text-center">FIFO</th>
                                <th class="px-6 py-4 text-center">G. Total</th>
                                <th class="px-6 py-4 text-center">G. Parcial</th>
                                <th class="px-6 py-4 text-center">Meta Calc.</th>
                                <th class="px-6 py-4 text-center">% Meta</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-corpo" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-performance" class="view-section hidden animate-fade-in space-y-6">
            <div class="flex flex-col md:flex-row justify-end items-center bg-white p-3 rounded-xl shadow-sm border border-slate-200 gap-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">Ref</span><input type="text" id="data-perf" class="w-24 bg-transparent text-center font-bold text-slate-700 outline-none text-sm" placeholder="DD/MM/AAAA" maxlength="10"></div>
                    <select id="perf-period-type" onchange="Perf.carregarRanking()" class="py-1.5 px-3 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 outline-none bg-slate-50 focus:border-blue-500 cursor-pointer"><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano">Anual</option></select>
                </div>
            </div>
            <div id="perf-view-individual">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1" id="perf-label-total">Total</p><p class="text-3xl font-black text-blue-700" id="perf-card-total">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média Diária</p><p class="text-3xl font-black text-slate-800" id="perf-card-media">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Meta Período</p><p class="text-3xl font-black text-slate-500" id="perf-card-meta">0</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 bg-gradient-to-br from-slate-50 to-white"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Top Ranking</p><div id="perf-rank-content" class="text-sm font-medium text-slate-700"></div></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-6">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-700">Ranking Detalhado</h3><button onclick="Perf.limparSelecao()" class="text-xs text-blue-600 hover:text-blue-800 font-bold hidden" id="perf-btn-limpar">✕ Limpar Seleção</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200"><tr><th class="px-6 py-3">#</th><th class="px-6 py-3">Assistente</th><th class="px-6 py-3 text-center text-blue-700 font-bold">Total</th><th class="px-6 py-3 text-center">Dias</th><th class="px-6 py-3 text-center">Média</th><th class="px-6 py-3 text-center">Meta Total</th><th class="px-6 py-3 text-center">% Meta</th></tr></thead><tbody id="perf-ranking-body" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="tab-matriz" class="view-section hidden animate-fade-in space-y-6">
            <div class="flex justify-between p-3 bg-white rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700">Visão Panorâmica</h3>
                <input type="text" id="data-matriz" class="w-24 bg-slate-50 text-center font-bold text-slate-700 outline-none text-sm p-1 rounded border border-slate-100" placeholder="DD/MM/AAAA" maxlength="10">
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-xs text-left"><tbody id="matriz-body"></tbody></table></div></div>
        </div>

        <div id="tab-consolidado" class="view-section hidden animate-fade-in space-y-6">
            <div class="flex justify-end p-3 bg-white rounded-xl shadow-sm border border-slate-200 gap-2">
                <input type="text" id="data-cons" class="w-24 bg-slate-50 text-center font-bold text-slate-700 outline-none text-sm p-1 rounded border border-slate-100" placeholder="DD/MM/AAAA" maxlength="10">
                <select id="cons-period-type" onchange="Cons.carregar()" class="text-sm font-bold text-slate-600 bg-transparent outline-none cursor-pointer"><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano_mes">Anual</option><option value="dia">Diário</option></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Produção Total</p><p class="text-3xl font-black text-blue-700" id="cons-p-total">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média do Time</p><p class="text-3xl font-black text-slate-800" id="cons-p-media-time">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden"><div class="absolute right-0 top-0 bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded-bl">Base 17</div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Média (Base Fixa)</p><p class="text-3xl font-black text-amber-600" id="cons-p-media-ind">0</p></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-xs font-bold text-slate-400 uppercase mb-1">Ativos</p><p class="text-3xl font-black text-slate-800" id="cons-p-headcount">0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead id="cons-table-header"></thead><tbody id="cons-table-body"></tbody></table></div></div>
        </div>
    </div>

    <script>
        const sessao = JSON.parse(localStorage.getItem('usuario'));
        const KEY_DATA_GLOBAL = 'data_sistema_global';

        function mudarAba(aba) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${aba}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${aba}`).classList.add('active');

            const dataAtual = localStorage.getItem(KEY_DATA_GLOBAL) || Sistema.Datas.formatar(new Date());
            if (aba === 'geral') { document.getElementById('data-validacao').value = dataAtual; Geral.carregarTela(); }
            if (aba === 'performance') { document.getElementById('data-perf').value = dataAtual; Perf.init(); }
            if (aba === 'matriz') { document.getElementById('data-matriz').value = dataAtual; Matriz.init(); }
            if (aba === 'consolidado') { document.getElementById('data-cons').value = dataAtual; Cons.init(); }
        }

        async function importarExcel(input) {
            const file = input.files[0];
            if (!file) return;
            const nomeArquivo = file.name;
            const matchData = nomeArquivo.match(/^(\d{2})(\d{2})(\d{4})/);
            if (!matchData) { alert("Nome inválido (ddmmaaaa.xlsx)"); input.value = ''; return; }
            const dataDoArquivo = `${matchData[3]}-${matchData[2]}-${matchData[1]}`;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    if (json.length === 0) return alert("Vazia.");

                    const usersMap = {};
                    const { data: users } = await _supabase.from('usuarios').select('id, nome');
                    users.forEach(u => usersMap[u.nome.trim().toLowerCase()] = u.id);

                    let inserts = [];
                    for (let row of json) {
                        const nomeCsv = row['assistente'];
                        const idCsv = row['id_assistente'];
                        if (!idCsv && !nomeCsv) continue;
                        if (String(nomeCsv).toLowerCase().includes('total')) continue;

                        let uid = idCsv;
                        if (!uid && nomeCsv && usersMap[nomeCsv.trim().toLowerCase()]) uid = usersMap[nomeCsv.trim().toLowerCase()];

                        if (uid) {
                            inserts.push({
                                usuario_id: uid, data_referencia: dataDoArquivo,
                                quantidade: row['documentos_validados'] || 0,
                                fifo: row['documentos_validados_fifo'] || 0,
                                gradual_total: row['documentos_validados_gradual_total'] || 0,
                                gradual_parcial: row['documentos_validados_gradual_parcial'] || 0,
                                perfil_fc: row['documentos_validados_perfil_fc'] || 0
                            });
                        }
                    }

                    if (inserts.length > 0) {
                        if(confirm(`Importar ${inserts.length} registros para ${matchData[1]}/${matchData[2]}/${matchData[3]}?`)) {
                            const { error } = await _supabase.from('producao').upsert(inserts, { onConflict: 'usuario_id, data_referencia' });
                            if (error) throw error;
                            alert("Sucesso!");
                            localStorage.setItem(KEY_DATA_GLOBAL, `${matchData[1]}/${matchData[2]}/${matchData[3]}`);
                            mudarAba('geral');
                        }
                    } else alert("Dados inválidos.");
                } catch (err) { alert("Erro: " + err.message); } finally { input.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        }

        const Geral = {
            listaAtual: [],
            selecionado: null,
            dataVisualizada: null,
            periodoInicio: null,
            periodoFim: null,

            toggleSemana: function() {
                const mode = document.getElementById('view-mode').value;
                const selSemana = document.getElementById('select-semana');
                if (mode === 'semana') selSemana.classList.remove('hidden'); else selSemana.classList.add('hidden');
                this.carregarTela();
            },
            
            carregarTela: async function() {
                const modo = document.getElementById('view-mode').value;
                const refDate = Sistema.Datas.lerInput('data-validacao');
                const isoDate = refDate.toISOString().split('T')[0];
                this.dataVisualizada = isoDate; 

                // Reset do seletor em massa
                const bulkSelect = document.getElementById('bulk-fator');
                if(bulkSelect) bulkSelect.value = "";

                // Definição dos limites do período para cálculo de metas
                let inicio, fim;
                if (modo === 'dia') { 
                    inicio = isoDate; fim = isoDate; 
                } else { 
                    const ano = refDate.getFullYear(); const mes = refDate.getMonth();
                    inicio = new Date(ano, mes, 1).toISOString().split('T')[0];
                    fim = new Date(ano, mes + 1, 0).toISOString().split('T')[0];
                }

                this.periodoInicio = inicio;
                this.periodoFim = fim;

                const { data } = await _supabase.from('producao').select('*').gte('data_referencia', inicio).lte('data_referencia', fim);
                let dadosFiltrados = data || [];
                
                if (modo === 'semana') {
                    const numSemana = parseInt(document.getElementById('select-semana').value);
                    dadosFiltrados = dadosFiltrados.filter(d => Sistema.Datas.getSemanaDoMes(d.data_referencia) === numSemana);
                }

                this.listaAtual = Sistema.Dados.normalizar(dadosFiltrados);
                this.renderizar();
            },

            // Função auxiliar para contar dias úteis (Seg-Sex)
            contarDiasUteis: function(inicioStr, fimStr) {
                if(!inicioStr || !fimStr) return 1;
                let count = 0;
                let cur = new Date(inicioStr + 'T12:00:00');
                const end = new Date(fimStr + 'T12:00:00');
                while(cur <= end) {
                    const d = cur.getDay();
                    if(d !== 0 && d !== 6) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                return count || 1;
            },

            mudarFator: function(nome, valor) {
                const modo = document.getElementById('view-mode').value;
                if (modo !== 'dia') {
                    alert("Atenção: Altere o fator apenas visualizando o 'Dia' específico.");
                    this.renderizar(); 
                    return;
                }
                Sistema.Dados.definirFator(nome, this.dataVisualizada, valor);
                this.carregarTela();
            },

            // Função de Alteração em Massa
            mudarFatorTodos: function(valor) {
                if (!valor) return; 
                const modo = document.getElementById('view-mode').value;
                if (modo !== 'dia') {
                    alert("Atenção: A alteração em massa só é permitida na visão 'Apenas o Dia' para evitar erros em históricos.");
                    document.getElementById('bulk-fator').value = "";
                    return;
                }

                if (!confirm("Tem certeza que deseja aplicar este fator para TODAS as assistentes listadas abaixo?")) {
                    document.getElementById('bulk-fator').value = "";
                    return;
                }

                this.listaAtual.forEach(u => {
                    if (!u.inativo) {
                        Sistema.Dados.definirFator(u.nome, this.dataVisualizada, valor);
                    }
                });

                this.carregarTela(); 
            },

            selecionar: function(nome) {
                if (this.selecionado === nome) this.selecionado = null; else this.selecionado = nome;
                this.renderizar();
            },
            limparSelecao: function() { this.selecionado = null; this.renderizar(); },

            renderizar: function() {
                const tbody = document.getElementById('tabela-corpo'); tbody.innerHTML = '';
                const modo = document.getElementById('view-mode').value;

                // Bloqueia o seletor em massa se não for dia
                const bulkSelect = document.getElementById('bulk-fator');
                if (bulkSelect) {
                    if (modo !== 'dia') {
                        bulkSelect.disabled = true;
                        bulkSelect.classList.add('opacity-50', 'cursor-not-allowed');
                        bulkSelect.title = "Disponível apenas na visão de Dia";
                    } else {
                        bulkSelect.disabled = false;
                        bulkSelect.classList.remove('opacity-50', 'cursor-not-allowed');
                        bulkSelect.title = "Alterar todas";
                    }
                }

                // 1. Filtragem de Ativos
                const ativos = this.listaAtual.filter(u => !u.inativo);
                
                const baseCalculo = this.selecionado 
                    ? this.listaAtual.filter(u => u.nome === this.selecionado) 
                    : ativos;

                const totalProd = baseCalculo.reduce((a, b) => a + b.total, 0);

                // --- Lógica de Contagem de Abonados e Meio Período ---
                let qtdMeio = 0;
                let qtdAbonado = 0;
                
                if (modo === 'dia' && !this.selecionado) {
                    this.listaAtual.forEach(u => {
                        const diaInfo = u.diasMap[this.dataVisualizada];
                        if (diaInfo) { 
                            if (diaInfo.fator === 0.5) qtdMeio++; 
                            else if (diaInfo.fator === 0) qtdAbonado++; 
                        }
                    });
                }
                
                // CÁLCULO DE EQUIPE CONSIDERADA (HEADCOUNT EFETIVO)
                let hcConsiderado = this.selecionado ? 1 : ativos.length;

                if (!this.selecionado && modo === 'dia') {
                    const reducaoParesMeio = Math.floor(qtdMeio / 2);
                    const reducaoAbonados = qtdAbonado;
                    hcConsiderado = ativos.length - reducaoAbonados - reducaoParesMeio;
                }

                // --- CÁLCULO DE META DINÂMICA ---
                let diasUteisPeriodo = 1;
                if(modo === 'dia') {
                    diasUteisPeriodo = 1;
                } else if (modo === 'mes') {
                    diasUteisPeriodo = this.contarDiasUteis(this.periodoInicio, this.periodoFim);
                } else if (modo === 'semana') {
                    if(this.listaAtual.length > 0) {
                        let todasDatas = new Set();
                        this.listaAtual.forEach(u => Object.keys(u.diasMap).forEach(d => todasDatas.add(d)));
                        let datasArr = Array.from(todasDatas).sort();
                        if(datasArr.length > 0) {
                            diasUteisPeriodo = this.contarDiasUteis(datasArr[0], datasArr[datasArr.length-1]);
                        } else diasUteisPeriodo = 5;
                    } else diasUteisPeriodo = 5;
                }

                const metaDiaria = 650;
                const metaTotalEsperada = diasUteisPeriodo * hcConsiderado * metaDiaria;
                const metaMediaIndividual = diasUteisPeriodo * metaDiaria;
                const mediaRealAnalista = hcConsiderado ? Math.round(totalProd / hcConsiderado) : 0;
                
                // --- CARD 1: EQUIPE ---
                let diasDisplay = 0;
                let diasLabel = "";
                if (this.selecionado) {
                    diasDisplay = baseCalculo.length ? baseCalculo[0].dias : 0; 
                    diasLabel = "Dias do Colaborador (Considera 50%)";
                } else {
                    const setDiasUnicos = new Set();
                    ativos.forEach(u => {
                        if (u.diasMap) { Object.entries(u.diasMap).forEach(([data, info]) => { if (info.fator > 0) setDiasUnicos.add(data); }); }
                    });
                    diasDisplay = setDiasUnicos.size;
                    diasLabel = "Dias Úteis da Equipe (Calendário)";
                }

                // Display Visual de Abonados
                const elInfoAbonados = document.getElementById('info-abonados');
                elInfoAbonados.classList.add('hidden'); 
                if ((qtdMeio > 0 || qtdAbonado > 0) && modo === 'dia' && !this.selecionado) {
                    let texto = [];
                    if (qtdMeio > 0) texto.push(`${qtdMeio} Meio Período`);
                    if (qtdAbonado > 0) texto.push(`${qtdAbonado} Abonado(s)`);
                    elInfoAbonados.innerText = texto.join(', ');
                    elInfoAbonados.classList.remove('hidden');
                }

                // Atualização dos Cards
                document.getElementById('kpi-hc').innerText = hcConsiderado;
                document.getElementById('kpi-dias').innerText = diasDisplay;
                document.getElementById('kpi-dias-label').innerText = diasLabel;
                
                document.getElementById('kpi-total').innerText = totalProd.toLocaleString();
                document.getElementById('kpi-meta-total').innerText = metaTotalEsperada.toLocaleString();
                document.getElementById('bar-prod').style.width = Math.min((totalProd/(metaTotalEsperada||1))*100, 100) + '%';

                document.getElementById('kpi-media').innerText = mediaRealAnalista.toLocaleString();
                document.getElementById('kpi-meta-media').innerText = metaMediaIndividual.toLocaleString();
                document.getElementById('bar-media').style.width = Math.min((mediaRealAnalista/(metaMediaIndividual||1))*100, 100) + '%';

                const percentual = metaTotalEsperada > 0 ? Math.round((totalProd / metaTotalEsperada) * 100) : 0;
                document.getElementById('kpi-pct').innerText = percentual + '%';
                document.getElementById('kpi-pct-detail').innerText = `${totalProd.toLocaleString()} / ${metaTotalEsperada.toLocaleString()}`;
                
                const cardPct = document.getElementById('card-pct');
                const iconPct = document.getElementById('icon-pct');
                cardPct.classList.remove('from-indigo-600', 'to-blue-700', 'from-red-600', 'to-rose-700', 'shadow-blue-200', 'shadow-rose-200');

                if (percentual < 100) {
                    cardPct.classList.add('from-red-600', 'to-rose-700', 'shadow-rose-200');
                    iconPct.innerHTML = '<i class="fas fa-times-circle text-white/50"></i>';
                } else {
                    cardPct.classList.add('from-indigo-600', 'to-blue-700', 'shadow-blue-200');
                    iconPct.innerHTML = '<i class="fas fa-check-circle text-white/50"></i>';
                }

                const selHeader = document.getElementById('selection-header');
                if (this.selecionado) { selHeader.classList.remove('hidden'); document.getElementById('selected-name').innerText = this.selecionado; } 
                else selHeader.classList.add('hidden');

                if(this.listaAtual.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-10 text-slate-400">Sem dados.</td></tr>'; return; }

                this.listaAtual.forEach(u => {
                    const isSelected = this.selecionado === u.nome;
                    const rowClass = isSelected ? "selected-row" : "hover:bg-slate-50";
                    const opacity = u.inativo ? "row-ignored" : "";
                    const subIds = u.ids.length > 1 ? `<br><span class="text-[9px] text-slate-400">IDs: ${u.ids.join(', ')}</span>` : '';

                    let fator = 1;
                    if (modo === 'dia') {
                         const infoDia = u.diasMap[this.dataVisualizada];
                         fator = infoDia ? infoDia.fator : 1;
                    } else {
                         if (u.dias === 0) fator = 0; else if (u.dias % 1 !== 0) fator = 0.5;
                    }
                    const fatorClass = fator === 1 ? 'st-1' : (fator === 0.5 ? 'st-05' : 'st-0');
                    const disabled = modo !== 'dia' ? 'disabled opacity-50 cursor-not-allowed' : '';

                    const selectHtml = `
                    <select class="status-select ${fatorClass} ${disabled}" onclick="event.stopPropagation()" onchange="Geral.mudarFator('${u.nome}', this.value)">
                        <option value="1" ${fator===1?'selected':''}>100%</option>
                        <option value="0.5" ${fator===0.5?'selected':''}>50%</option>
                        <option value="0" ${fator===0?'selected':''}>0%</option>
                    </select>`;

                    // CÁLCULO DA PORCENTAGEM INDIVIDUAL
                    const pctIndividual = u.meta > 0 ? Math.round((u.total / u.meta) * 100) : 0;
                    
                    // Definição da cor do badge
                    let badgeClass = '';
                    if (pctIndividual >= 100) {
                        badgeClass = 'bg-emerald-100 text-emerald-800 border-emerald-200';
                    } else {
                        badgeClass = 'bg-rose-100 text-rose-800 border-rose-200';
                    }

                    const pctBadge = `<span class="${badgeClass} px-2 py-1 rounded text-xs font-bold border">${pctIndividual}%</span>`;

                    tbody.innerHTML += `<tr class="${rowClass} ${opacity} transition border-b border-slate-100 cursor-pointer"><td class="px-4 py-4 text-center">${selectHtml}</td><td class="px-6 py-4 font-bold text-slate-700" onclick="Geral.selecionar('${u.nome}')">${u.nome} ${subIds}</td><td class="px-6 py-4 text-center text-slate-500">${u.dias}</td><td class="px-6 py-4 text-center font-bold text-blue-700">${u.total.toLocaleString()}</td><td class="px-6 py-4 text-center text-slate-600">${u.fifo}</td><td class="px-6 py-4 text-center text-slate-600">${u.gt}</td><td class="px-6 py-4 text-center text-slate-600">${u.gp}</td><td class="px-6 py-4 text-center text-slate-400">${u.meta.toLocaleString()}</td><td class="px-6 py-4 text-center">${pctBadge}</td></tr>`;
                });
            }
        };

        // --- INICIALIZAÇÃO GLOBAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            Sistema.Datas.criarInputInteligente('data-validacao', KEY_DATA_GLOBAL, Geral.carregarTela);
            await Sistema.Dados.inicializar(); 
            Geral.carregarTela();
        });
    </script>
</body>
</html>