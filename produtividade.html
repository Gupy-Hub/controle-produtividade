// ARQUIVO: js/produtividade/performance.js
window.Produtividade = window.Produtividade || {};

Produtividade.Performance = {
    initialized: false,
    chart: null,

    init: function() {
        console.log("üèéÔ∏è Performance: M√≥dulo Iniciado (Gest√£o H√≠brida)");
        this.initialized = true;
    },

    carregar: async function() {
        if(document.getElementById('tab-performance').classList.contains('hidden')) return;

        console.log("üèéÔ∏è Performance: Carregando dados...");
        const datas = Produtividade.getDatasFiltro();
        const usuarioId = Produtividade.Geral.usuarioSelecionado;
        const nomeUsuario = document.getElementById('selected-name')?.textContent;

        this.atualizarHeader(usuarioId, nomeUsuario);

        try {
            // 1. BUSCA DADOS BRUTOS (JOIN com Usu√°rios para ter os nomes)
            let query = Sistema.supabase
                .from('assertividade')
                .select('data_referencia, usuario_id, porcentagem_assertividade, usuarios(nome)')
                .gte('data_referencia', datas.inicio)
                .lte('data_referencia', datas.fim);
            
            // Se tiver filtro, aplica no banco para o gr√°fico/kpis
            // Mas se for vis√£o geral, pegamos tudo para montar o ranking
            // OBS: Para performance, vamos pegar TUDO sempre e filtrar no JS para permitir o Ranking
            const { data, error } = await query;

            if (error) throw error;

            this.processarDados(data, datas.inicio, datas.fim, usuarioId);

        } catch (error) {
            console.error("Erro Performance:", error);
            alert("Erro ao carregar performance: " + error.message);
        }
    },

    atualizarHeader: function(uid, nome) {
        const badge = document.getElementById('perf-badge-filtro');
        const span = document.getElementById('perf-nome-filtro');
        const tableTitle = document.getElementById('perf-table-title');
        const th1 = document.getElementById('perf-th-1');
        
        if (uid && nome) {
            badge.classList.remove('hidden');
            span.innerText = nome;
            if(tableTitle) tableTitle.innerText = `Hist√≥rico Di√°rio: ${nome}`;
            if(th1) th1.innerText = "Data";
        } else {
            badge.classList.add('hidden');
            if(tableTitle) tableTitle.innerText = "Ranking da Equipe";
            if(th1) th1.innerText = "Assistente";
        }
    },

    processarDados: function(registros, dataInicio, dataFim, filtroUsuarioId) {
        const mapaDias = {};     // Para o Gr√°fico (Evolu√ß√£o Temporal)
        const mapaAgentes = {};  // Para a Tabela (Ranking)

        // Inicializa gr√°fico com datas vazias
        let curr = new Date(dataInicio + 'T12:00:00');
        const end = new Date(dataFim + 'T12:00:00');
        while (curr <= end) {
            mapaDias[curr.toISOString().split('T')[0]] = { soma: 0, qtd: 0 };
            curr.setDate(curr.getDate() + 1);
        }

        let totalSoma = 0;
        let totalQtd = 0;

        registros.forEach(reg => {
            if (!reg.porcentagem_assertividade) return;

            // 1. Tratamento de Dados
            const valorNum = parseFloat(reg.porcentagem_assertividade.replace('%', '').replace(',', '.'));
            
            // Regra Fim de Semana
            let dataRef = new Date(reg.data_referencia + 'T12:00:00');
            const diaSemana = dataRef.getDay();
            if (diaSemana === 6) dataRef.setDate(dataRef.getDate() - 1);
            if (diaSemana === 0) dataRef.setDate(dataRef.getDate() - 2);
            const dataKey = dataRef.toISOString().split('T')[0];

            const uid = reg.usuario_id;
            const nome = reg.usuarios?.nome || 'Desconhecido';

            // 2. Acumula para Ranking (Agrupado por Agente)
            if (!mapaAgentes[uid]) mapaAgentes[uid] = { nome: nome, soma: 0, qtd: 0, historico: [] };
            mapaAgentes[uid].soma += valorNum;
            mapaAgentes[uid].qtd += 1;
            // Salva detalhe para vis√£o filtrada
            mapaAgentes[uid].historico.push({ data: dataKey, valor: valorNum });

            // 3. L√≥gica de Filtro para KPIs e Gr√°fico
            // Se n√£o tem filtro OU se o registro √© do usu√°rio filtrado
            if (!filtroUsuarioId || filtroUsuarioId == uid) {
                if (mapaDias[dataKey]) {
                    mapaDias[dataKey].soma += valorNum;
                    mapaDias[dataKey].qtd += 1;
                }
                totalSoma += valorNum;
                totalQtd += 1;
            }
        });

        // Renderiza KPIs e Gr√°fico (Baseado no filtro aplicado)
        this.renderizarKPIs(totalSoma, totalQtd);
        this.renderizarGrafico(mapaDias);

        // Renderiza Tabela (L√≥gica H√≠brida)
        this.renderizarTabela(mapaAgentes, filtroUsuarioId, mapaDias);
    },

    renderizarKPIs: function(soma, qtd) {
        const media = qtd > 0 ? (soma / qtd) : 0;
        
        const elMedia = document.getElementById('perf-kpi-media');
        const elBar = document.getElementById('perf-bar-media');
        if(elMedia) elMedia.innerText = media.toFixed(2).replace('.', ',') + '%';
        if(elBar) elBar.style.width = Math.min(media, 100) + '%';

        const elVol = document.getElementById('perf-kpi-volume');
        if(elVol) elVol.innerText = qtd.toLocaleString('pt-BR');

        const elStatus = document.getElementById('perf-badge-status');
        const elDesc = document.getElementById('perf-status-desc');
        const meta = 98.0;

        if (qtd === 0) {
            elStatus.className = "px-3 py-1 rounded-lg text-sm font-bold bg-slate-100 text-slate-500";
            elStatus.innerText = "Sem Dados";
            elDesc.innerText = "Aguardando auditorias...";
        } else if (media >= meta) {
            elStatus.className = "px-3 py-1 rounded-lg text-sm font-bold bg-emerald-100 text-emerald-700 border border-emerald-200";
            elStatus.innerText = "Meta Atingida! üèÜ";
            elDesc.innerText = `Parab√©ns! Acima de ${meta}%`;
        } else {
            const gap = (meta - media).toFixed(2);
            elStatus.className = "px-3 py-1 rounded-lg text-sm font-bold bg-rose-100 text-rose-700 border border-rose-200";
            elStatus.innerText = "Abaixo da Meta";
            elDesc.innerText = `Faltam ${gap}% para ${meta}%`;
        }
    },

    renderizarGrafico: function(mapaDias) {
        const ctx = document.getElementById('chartPerformance');
        if (!ctx) return;

        const labels = Object.keys(mapaDias).sort();
        const dadosVolume = [];
        const dadosMedia = [];

        labels.forEach(dia => {
            const d = mapaDias[dia];
            const media = d.qtd > 0 ? (d.soma / d.qtd) : null;
            dadosVolume.push(d.qtd);
            dadosMedia.push(media ? media.toFixed(2) : null);
        });

        const labelsFormatados = labels.map(d => d.split('-').reverse().slice(0, 2).join('/'));

        if (this.chart) this.chart.destroy();

        this.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labelsFormatados,
                datasets: [
                    {
                        label: 'Volume',
                        data: dadosVolume,
                        backgroundColor: '#bfdbfe',
                        borderRadius: 4,
                        order: 2,
                        yAxisID: 'yVolume'
                    },
                    {
                        label: 'Assertividade (%)',
                        data: dadosMedia,
                        type: 'line',
                        borderColor: '#10b981',
                        backgroundColor: '#10b981',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#10b981',
                        tension: 0.3,
                        order: 1,
                        yAxisID: 'yPercent',
                        spanGaps: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                    yVolume: { display: false, position: 'right' },
                    yPercent: { 
                        display: true, position: 'left', min: 80, max: 105,
                        grid: { borderDash: [5, 5] },
                        ticks: { callback: v => v + '%' }
                    }
                }
            }
        });
    },

    renderizarTabela: function(mapaAgentes, filtroUsuarioId, mapaDias) {
        const tbody = document.getElementById('perf-table-body');
        if(!tbody) return;
        tbody.innerHTML = '';

        // MODO 1: TABELA DE RANKING (Sem Filtro)
        if (!filtroUsuarioId) {
            const lista = Object.values(mapaAgentes).sort((a,b) => (b.soma/b.qtd) - (a.soma/a.qtd));
            
            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-400">Nenhum dado encontrado.</td></tr>';
                return;
            }

            lista.forEach(agente => {
                const media = agente.qtd > 0 ? (agente.soma / agente.qtd) : 0;
                const statusColor = media >= 98 ? 'text-emerald-600 bg-emerald-50 border-emerald-100' : 'text-rose-600 bg-rose-50 border-rose-100';
                
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                        <td class="px-6 py-4 font-bold text-slate-700">${agente.nome}</td>
                        <td class="px-6 py-4 text-center font-mono text-slate-500">${agente.qtd}</td>
                        <td class="px-6 py-4 text-center font-bold text-slate-600">${media.toFixed(2)}%</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold border ${statusColor}">
                                ${media >= 98 ? 'Meta Batida' : 'Aten√ß√£o'}
                            </span>
                        </td>
                    </tr>
                `;
            });

        // MODO 2: HIST√ìRICO DI√ÅRIO (Com Filtro)
        } else {
            // Se o usu√°rio filtrado n√£o tiver dados
            if (!mapaAgentes[filtroUsuarioId]) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-400">Sem hist√≥rico para este usu√°rio no per√≠odo.</td></tr>';
                return;
            }

            // Pega os dias do gr√°fico (que j√° est√£o tratados com a regra de fim de semana)
            // Filtra apenas dias que tiveram auditoria
            const diasComDados = Object.keys(mapaDias).filter(d => mapaDias[d].qtd > 0).sort();

            diasComDados.forEach(dia => {
                const d = mapaDias[dia];
                const media = d.soma / d.qtd;
                const dataFmt = dia.split('-').reverse().join('/');
                const statusColor = media >= 98 ? 'text-emerald-600 bg-emerald-50 border-emerald-100' : 'text-rose-600 bg-rose-50 border-rose-100';

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                        <td class="px-6 py-4 font-bold text-slate-700">${dataFmt}</td>
                        <td class="px-6 py-4 text-center font-mono text-slate-500">${d.qtd}</td>
                        <td class="px-6 py-4 text-center font-bold text-slate-600">${media.toFixed(2)}%</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold border ${statusColor}">
                                ${media >= 98 ? 'OK' : 'Baixo'}
                            </span>
                        </td>
                    </tr>
                `;
            });
        }
    }
};