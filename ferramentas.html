<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas e Recursos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
        .tab-active { background-color: #eff6ff; color: #1d4ed8; border-color: #2563eb; }
        .tab-inactive { color: #64748b; border-color: transparent; }
        .tab-inactive:hover { color: #334155; border-color: #cbd5e1; }
    </style>
</head>
<body class="text-slate-800">

    <script>
        const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
        const _supabase = window.supabase ? window.supabase.createClient(SB_URL, SB_KEY) : null;

        function renderNavbar() {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario) { window.location.href = 'index.html'; return; }

            const navbarHTML = `
            <nav class="bg-slate-900 text-white fixed top-0 left-0 w-full z-50 shadow-lg h-16 flex items-center justify-between px-6">
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='produtividade.html'">
                    <div class="flex flex-col leading-tight">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Controle de</span>
                        <span class="text-xl font-extrabold tracking-tighter text-white">PRODUTIVIDADE</span>
                    </div>
                </div>
                <div class="hidden md:flex items-center gap-1 h-full">
                    ${createNavLink('Gest√£o', 'gestao.html')}
                    ${createNavLink('Produtividade', 'produtividade.html')}
                    ${createNavLink('Performance', 'performance.html')}
                    ${createNavLink('Consolidado', 'consolidado.html')}
                    ${createNavLink('Minha √Årea', 'minha_area.html')}
                    ${createNavLink('Ferramentas', 'ferramentas.html')}
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <span class="block text-sm font-bold text-white">${usuario.nome}</span>
                        <span class="block text-xs text-slate-400">${usuario.funcao}</span>
                    </div>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-semibold border border-red-900/50 bg-red-900/10 px-3 py-1 rounded transition">Sair</button>
                </div>
            </nav>
            <div class="h-20"></div>`;
            document.body.insertAdjacentHTML('afterbegin', navbarHTML);
        }
        function createNavLink(label, linkUrl) {
            const activeClass = window.location.href.includes(linkUrl) ? "bg-blue-700 text-white shadow-md" : "text-slate-300 hover:bg-slate-800 hover:text-white";
            return `<a href="${linkUrl}" class="${activeClass} px-4 py-2 rounded-lg text-sm font-medium transition duration-200">${label}</a>`;
        }
        function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }
        renderNavbar();
    </script>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Ferramentas √öteis</h1>
                <p class="text-slate-500 text-sm">Biblioteca de conhecimento e calculadoras trabalhistas.</p>
            </div>
            
            <div class="flex border-b border-slate-200">
                <button onclick="switchTab('lib')" id="btn-lib" class="px-6 py-2 text-sm font-bold border-b-2 tab-active transition">üìö Biblioteca</button>
                <button onclick="switchTab('calc')" id="btn-calc" class="px-6 py-2 text-sm font-bold border-b-2 tab-inactive transition">üßÆ Calculadoras</button>
            </div>
        </div>

        <div id="tab-lib" class="space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex gap-4 justify-between items-center">
                <input type="text" id="lib-search" onkeyup="filtrarFrases()" placeholder="üîç Buscar frase ou tag..." class="w-full max-w-lg bg-slate-50 border border-slate-300 rounded-lg px-4 py-2 text-sm">
                <button onclick="abrirModalFrase()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                    + Nova Frase
                </button>
            </div>

            <div id="lib-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-10 text-slate-400">Carregando biblioteca...</div>
            </div>
        </div>

        <div id="tab-calc" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-2">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <h3 class="font-bold text-slate-700 mb-3 px-2">Escolha a Calculadora</h3>
                    <button onclick="showCalc('rescisao')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-blue-50 text-slate-600 hover:text-blue-700 font-medium transition flex justify-between">üìÑ Rescis√£o <span>‚Üí</span></button>
                    <button onclick="showCalc('ferias')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-blue-50 text-slate-600 hover:text-blue-700 font-medium transition flex justify-between">üèñÔ∏è F√©rias <span>‚Üí</span></button>
                    <button onclick="showCalc('decimo')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-blue-50 text-slate-600 hover:text-blue-700 font-medium transition flex justify-between">üéÅ 13¬∫ Sal√°rio <span>‚Üí</span></button>
                    <button onclick="showCalc('fgts')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-blue-50 text-slate-600 hover:text-blue-700 font-medium transition flex justify-between">üè¶ FGTS L√≠quido <span>‚Üí</span></button>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div id="calc-container" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="text-center text-slate-400 py-10">
                        Select a calculator on the left to start.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-frase" class="fixed inset-0 bg-black/50 z-[100] hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Adicionar √† Biblioteca</h3>
                <button onclick="fecharModalFrase()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">T√≠tulo</label>
                    <input type="text" id="form-titulo" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Conte√∫do</label>
                    <textarea id="form-conteudo" rows="4" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tags (separadas por v√≠rgula)</label>
                    <input type="text" id="form-tags" placeholder="Ex: sauda√ß√£o, erro, email" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5">
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                <button onclick="salvarFrase()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        const sessao = JSON.parse(localStorage.getItem('usuario'));
        let frasesGlobal = [];

        document.addEventListener('DOMContentLoaded', () => {
            carregarFrases();
            showCalc('rescisao'); // Default
        });

        // --- NAVEGA√á√ÉO ---
        function switchTab(tab) {
            document.getElementById('tab-lib').classList.add('hidden');
            document.getElementById('tab-calc').classList.add('hidden');
            document.getElementById('btn-lib').className = 'px-6 py-2 text-sm font-bold border-b-2 transition tab-inactive';
            document.getElementById('btn-calc').className = 'px-6 py-2 text-sm font-bold border-b-2 transition tab-inactive';

            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).className = 'px-6 py-2 text-sm font-bold border-b-2 transition tab-active';
        }

        // --- BIBLIOTECA DE FRASES ---
        async function carregarFrases() {
            const container = document.getElementById('lib-grid');
            const { data, error } = await _supabase.from('biblioteca').select('*').order('created_at', { ascending: false });
            
            if (error) {
                console.error(error);
                container.innerHTML = '<div class="col-span-full text-center text-red-500">Erro ao carregar frases (Tabela n√£o existe?).</div>';
                return;
            }

            frasesGlobal = data || [];
            renderizarFrases(frasesGlobal);
        }

        function renderizarFrases(lista) {
            const container = document.getElementById('lib-grid');
            if (lista.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">Nenhuma frase encontrada. Adicione a primeira!</div>';
                return;
            }

            let html = '';
            lista.forEach(item => {
                const tagsHtml = item.tags ? item.tags.split(',').map(t => `<span class="bg-slate-100 text-slate-600 text-[10px] px-2 py-1 rounded-full uppercase font-bold">${t.trim()}</span>`).join('') : '';
                
                // Escapar aspas para o onclick
                const safeContent = item.conteudo.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n');

                html += `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition flex flex-col h-full">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-bold text-slate-800">${item.titulo}</h4>
                        <button onclick="copiarTexto('${safeContent}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 transition">
                            üìã Copiar
                        </button>
                    </div>
                    <p class="text-slate-600 text-sm mb-4 flex-1 whitespace-pre-wrap font-mono bg-slate-50 p-2 rounded border border-slate-100">${item.conteudo}</p>
                    <div class="flex flex-wrap gap-2 mt-auto">
                        ${tagsHtml}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function filtrarFrases() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const filtered = frasesGlobal.filter(f => 
                f.titulo.toLowerCase().includes(term) || 
                f.conteudo.toLowerCase().includes(term) || 
                (f.tags && f.tags.toLowerCase().includes(term))
            );
            renderizarFrases(filtered);
        }

        function copiarTexto(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                alert("Texto copiado para a √°rea de transfer√™ncia!");
            });
        }

        function abrirModalFrase() { document.getElementById('modal-frase').classList.remove('hidden'); document.getElementById('modal-frase').classList.add('flex'); }
        function fecharModalFrase() { document.getElementById('modal-frase').classList.add('hidden'); document.getElementById('modal-frase').classList.remove('flex'); }

        async function salvarFrase() {
            const titulo = document.getElementById('form-titulo').value;
            const conteudo = document.getElementById('form-conteudo').value;
            const tags = document.getElementById('form-tags').value;

            if (!titulo || !conteudo) return alert("Preencha T√≠tulo e Conte√∫do.");

            const { error } = await _supabase.from('biblioteca').insert({
                titulo, conteudo, tags, criado_por: sessao.nome
            });

            if (error) alert("Erro: " + error.message);
            else {
                fecharModalFrase();
                document.getElementById('form-titulo').value = '';
                document.getElementById('form-conteudo').value = '';
                document.getElementById('form-tags').value = '';
                carregarFrases();
            }
        }

        // --- CALCULADORAS (Portadas do c√≥digo antigo) ---
        function showCalc(type) {
            const container = document.getElementById('calc-container');
            let html = '';

            if (type === 'rescisao') {
                html = `
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">üìÑ Simulador de Rescis√£o</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500">Sal√°rio Base</label><input type="number" id="c-salario" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Meses Trabalhados</label><input type="number" id="c-meses" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Dias de F√©rias Vencidas</label><input type="number" id="c-ferias-dias" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Aviso Pr√©vio (0=N√£o, 1=Indenizado)</label><select id="c-aviso" class="w-full border p-2 rounded"><option value="0">Trabalhado</option><option value="1">Indenizado</option></select></div>
                    </div>
                    <button onclick="calcRescisao()" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded w-full">Calcular</button>
                    <div id="c-res-result" class="mt-4 p-4 bg-slate-50 rounded hidden text-sm font-mono"></div>
                `;
            } else if (type === 'ferias') {
                html = `
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">üèñÔ∏è Simulador de F√©rias</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500">Sal√°rio</label><input type="number" id="f-salario" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Dias de F√©rias</label><input type="number" id="f-dias" value="30" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Vender 10 dias? (Abono)</label><select id="f-abono" class="w-full border p-2 rounded"><option value="0">N√£o</option><option value="1">Sim</option></select></div>
                    </div>
                    <button onclick="calcFerias()" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded w-full">Calcular</button>
                    <div id="f-result" class="mt-4 p-4 bg-slate-50 rounded hidden text-sm font-mono"></div>
                `;
            } else if (type === 'decimo') {
                html = `
                     <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">üéÅ 13¬∫ Sal√°rio</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500">Sal√°rio</label><input type="number" id="d-salario" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Meses Trabalhados no Ano</label><input type="number" id="d-meses" value="12" class="w-full border p-2 rounded"></div>
                        <div><label class="text-xs font-bold text-slate-500">Parcela</label><select id="d-parcela" class="w-full border p-2 rounded"><option value="1">1¬™ Parcela (sem desconto)</option><option value="2">2¬™ Parcela (com descontos)</option></select></div>
                    </div>
                    <button onclick="calcDecimo()" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded w-full">Calcular</button>
                    <div id="d-result" class="mt-4 p-4 bg-slate-50 rounded hidden text-sm font-mono"></div>
                `;
            } else {
                html = `<div class="p-10 text-center text-slate-400">Calculadora de FGTS em desenvolvimento...</div>`;
            }
            container.innerHTML = html;
        }

        // --- L√ìGICA DE C√ÅLCULO ---
        function calcRescisao() {
            const salario = parseFloat(document.getElementById('c-salario').value) || 0;
            const meses = parseInt(document.getElementById('c-meses').value) || 0;
            const feriasDias = parseInt(document.getElementById('c-ferias-dias').value) || 0;
            const aviso = document.getElementById('c-aviso').value === "1";

            const saldoSalario = salario; // Simplificado
            const decimoProp = (salario / 12) * (meses % 12); // Apenas l√≥gica b√°sica
            const feriasVencidas = (salario / 30) * feriasDias * 1.33;
            const feriasProp = (salario / 12) * (meses % 12) * 1.33;
            const valorAviso = aviso ? salario : 0;
            const multaFgts = (salario * 0.08 * meses) * 0.40; // Estimativa

            const total = saldoSalario + decimoProp + feriasVencidas + feriasProp + valorAviso + multaFgts;

            const r = document.getElementById('c-res-result');
            r.innerHTML = `
                <div class="flex justify-between mb-1"><span>Saldo Sal√°rio (Est.):</span> <span>R$ ${saldoSalario.toFixed(2)}</span></div>
                <div class="flex justify-between mb-1"><span>13¬∫ Proporcional:</span> <span>R$ ${decimoProp.toFixed(2)}</span></div>
                <div class="flex justify-between mb-1"><span>F√©rias + 1/3:</span> <span>R$ ${(feriasVencidas + feriasProp).toFixed(2)}</span></div>
                <div class="flex justify-between mb-1"><span>Aviso Pr√©vio:</span> <span>R$ ${valorAviso.toFixed(2)}</span></div>
                <div class="flex justify-between mb-1 text-slate-500"><span>Multa FGTS (Est.):</span> <span>R$ ${multaFgts.toFixed(2)}</span></div>
                <div class="border-t pt-2 font-bold text-lg flex justify-between text-blue-700 mt-2"><span>TOTAL BRUTO ESTIMADO:</span> <span>R$ ${total.toFixed(2)}</span></div>
                <div class="text-[10px] text-red-400 mt-2">* Valores aproximados. N√£o substitui c√°lculo cont√°bil oficial.</div>
            `;
            r.classList.remove('hidden');
        }

        function calcFerias() {
            const salario = parseFloat(document.getElementById('f-salario').value) || 0;
            const dias = parseInt(document.getElementById('f-dias').value) || 30;
            const abono = document.getElementById('f-abono').value === "1";

            let valorFerias = (salario / 30) * dias;
            let umTerco = valorFerias / 3;
            let abonoPecuniario = 0;
            let umTercoAbono = 0;

            if (abono) {
                valorFerias = (salario / 30) * (dias - 10);
                umTerco = valorFerias / 3;
                abonoPecuniario = (salario / 30) * 10;
                umTercoAbono = abonoPecuniario / 3;
            }

            const total = valorFerias + umTerco + abonoPecuniario + umTercoAbono;
            
            // INSS/IRRF simplificado (apenas estimativa de desconto 10%)
            const descontos = total * 0.09; 
            const liquido = total - descontos;

            const r = document.getElementById('f-result');
            r.innerHTML = `
                <div class="flex justify-between mb-1"><span>Valor F√©rias:</span> <span>R$ ${valorFerias.toFixed(2)}</span></div>
                <div class="flex justify-between mb-1"><span>1/3 F√©rias:</span> <span>R$ ${umTerco.toFixed(2)}</span></div>
                ${abono ? `<div class="flex justify-between mb-1 text-blue-600"><span>Abono Pecuni√°rio:</span> <span>R$ ${(abonoPecuniario + umTercoAbono).toFixed(2)}</span></div>` : ''}
                <div class="flex justify-between mb-1 text-red-400"><span>Descontos Est. (INSS/IR):</span> <span>- R$ ${descontos.toFixed(2)}</span></div>
                <div class="border-t pt-2 font-bold text-lg flex justify-between text-emerald-700 mt-2"><span>L√çQUIDO A RECEBER:</span> <span>R$ ${liquido.toFixed(2)}</span></div>
            `;
            r.classList.remove('hidden');
        }

        function calcDecimo() {
            const salario = parseFloat(document.getElementById('d-salario').value) || 0;
            const meses = parseInt(document.getElementById('d-meses').value) || 12;
            const parcela = document.getElementById('d-parcela').value;

            const total = (salario / 12) * meses;
            let resultado = 0;
            let texto = "";

            if (parcela === "1") {
                resultado = total / 2;
                texto = "1¬™ Parcela (50%)";
            } else {
                const primeira = total / 2;
                const descontos = total * 0.09; // Estimativa INSS
                resultado = total - primeira - descontos;
                texto = "2¬™ Parcela (Restante - Descontos)";
            }

            const r = document.getElementById('d-result');
            r.innerHTML = `
                <div class="flex justify-between mb-1"><span>Valor Integral:</span> <span>R$ ${total.toFixed(2)}</span></div>
                <div class="border-t pt-2 font-bold text-lg flex justify-between text-blue-700 mt-2"><span>${texto}:</span> <span>R$ ${resultado.toFixed(2)}</span></div>
            `;
            r.classList.remove('hidden');
        }
    </script>
</body>
</html>